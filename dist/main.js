(()=>{"use strict";var e={380:(e,t,r)=>{var o=r(555);const n=e=>{const t=document.querySelector(e);t.textContent="";for(let e=0;e<10;e+=1)for(let r=0;r<10;r+=1){const n=o.r.convertToAlphanumeric([e,r]),a=document.createElement("div");a.classList.add("square"),a.dataset.coordinate=n,t.appendChild(a)}},a=(e,t)=>{document.querySelector(e).querySelectorAll(".square").forEach((e=>{t.forEach((t=>{e.addEventListener(t.eventType,t.handler)}))}))},l=e=>{document.querySelector("#winner").textContent=`${e} won!`},s=e=>{document.querySelector(e).querySelectorAll(".square").forEach((e=>{e.className="square"}))};var c=r(776);(()=>{const e=(0,c.Br)(),t=(0,c.Br)(),r=(0,c.oP)("computer");let i=0,d=!0,u=!1,h=null;const p=n=>{if(!d){const a=n.target,s=a.dataset.coordinate;t.getAttackedCoordinates().includes(s)||(t.receiveAttack(s)?a.classList.add("hit"):a.classList.add("miss"),t.allShipsSunk()&&(h="You",l(h),o.U.toggleModal(document.querySelector(".modal.endgame"),"show")),(()=>{if(!d){const t=r.attack(e,r.lastHitCoordinate,r.currentDirection),n=e.receiveAttack(t),a=document.querySelector(`.gameboard.player [data-coordinate="${t}"]`);n?(a.classList.add("hit"),r.lastHitCoordinate=t,null===r.currentDirection&&(r.currentDirection="up")):!n&&r.lastHitCoordinate?a.classList.add("miss"):n||r.lastHitCoordinate||(a.classList.add("miss"),r.lastHitCoordinate=null,r.currentDirection=null),e.allShipsSunk()&&(h="The computer",l(h),o.U.toggleModal(document.querySelector(".modal.endgame"),"show"))}})())}},m=()=>{u=!u},g=[{eventType:"mouseover",handler:e=>{if(d){const t=e.target.dataset.coordinate,{length:r}=o.U.shipTypes[i],[n,a]=o.r.convertToIndices(t);Array.from({length:r},((e,t)=>{const r=u?n+t:n,l=u?a:a+t;return{initialSquare:document.querySelector(`.gameboard.initial [data-coordinate="${o.r.convertToAlphanumeric([r,l])}"]`)}})).forEach((({initialSquare:e})=>{e&&e.classList.add("hovered")}))}}},{eventType:"mouseleave",handler:()=>{document.querySelectorAll(".gameboard .hovered").forEach((e=>{e.classList.remove("hovered")}))}},{eventType:"click",handler:r=>{if(d){const n=r.target,{coordinate:a}=n.dataset,{length:l}=o.U.shipTypes[i],[s,h]=o.r.convertToIndices(a),p=Array.from({length:l},((e,t)=>[u?s+t:s,u?h:h+t])),m=(0,c._V)(l);if(e.placeShip(m,p))if(n.classList.add("placed"),p.forEach((([e,t])=>{document.querySelector(`[data-coordinate="${o.r.convertToAlphanumeric([e,t])}"]`).classList.add("placed"),document.querySelector(`.gameboard.initial [data-coordinate="${o.r.convertToAlphanumeric([e,t])}"]`).classList.add("placed")})),i+=1,i===o.U.shipTypes.length)d=!1,(()=>{for(const e of o.U.shipTypes){const{length:r}=e,o=(0,c._V)(r),n=10;let a,l=!1;for(;!l;){const e=Math.floor(Math.random()*n),s=Math.floor(Math.random()*n);u=Math.random()<.5,u&&e+r<=n?a=Array.from({length:r},((t,r)=>[e+r,s])):!u&&s+r<=n&&(a=Array.from({length:r},((t,r)=>[e,s+r]))),a&&(l=t.placeShip(o,a))}}})(),setTimeout((()=>{o.U.toggleModal(document.querySelector(".modal.initial"),"hide")}),500);else{const e=o.U.shipTypes[i].type;document.querySelector(".ship-type").textContent=e}}}}];return{init:()=>{o.U.toggleModal(document.querySelector(".modal.endgame"),"hide"),n(".gameboard.initial"),n(".gameboard.player"),n(".gameboard.computer"),a(".gameboard.initial",g),document.querySelectorAll(".gameboard.computer .square").forEach((e=>{e.addEventListener("click",p)})),document.querySelector("#rotateBtn").addEventListener("click",m),document.querySelector("#newGame").addEventListener("click",(()=>{i=0,d=!0,u=!1,h=null,r.lastHitCoordinate=null,r.currentDirection=null,e.reset(),t.reset(),r.clearSet(),s(".gameboard.initial"),s(".gameboard.player"),s(".gameboard.computer"),document.querySelector(".ship-type").textContent=o.U.shipTypes[0].type,o.U.toggleModal(document.querySelector(".modal.endgame"),"hide"),o.U.toggleModal(document.querySelector(".modal.initial"),"show")}))}}})().init()},776:(e,t,r)=>{r.d(t,{Br:()=>a,_V:()=>n,oP:()=>l});var o=r(555);const n=e=>{let t=0;return{length:e,hit:()=>{t+=1},isSunk:()=>t>=e,get hits(){return t}}},a=()=>{const e=10,t=Array.from({length:e},(()=>Array(e).fill(null)));let r=[],o=[];const n=()=>{const r=[];for(let o=0;o<e;o+=1)for(let n=0;n<e;n+=1){const e=t[o][n];null===e||!e.ship||r.includes(e.ship)||e.ship.isSunk()||r.push(e.ship)}return r};return{getGrid:()=>t,placeShip:(r,o)=>{const n=o.every((([t,r])=>t>=0&&t<e&&r>=0&&r<e)),a=o.some((([e,r])=>null!==t[e][r])),l=o.some((([r,o])=>[[r-1,o],[r+1,o],[r,o-1],[r,o+1],[r-1,o-1],[r-1,o+1],[r+1,o-1],[r+1,o+1]].some((([r,o])=>r>=0&&r<e&&o>=0&&o<e&&null!==t[r]?.[o]))));if(n&&!a&&!l){const e={ship:r,coordinates:o};return e.coordinates.forEach((([r,o])=>{t[r][o]=e})),!0}return!1},getShips:n,getAllShips:()=>{const r=[];for(let o=0;o<e;o+=1)for(let n=0;n<e;n+=1){const e=t[o][n];null!==e&&e.ship&&!r.includes(e.ship)&&r.push(e.ship)}return r},getShipCoordinates:r=>{const o=[];for(let n=0;n<e;n+=1)for(let a=0;a<e;a+=1){const e=t[n][a];e&&e.ship===r&&o.push([n,a])}return o},receiveAttack:e=>{const[n,a]=e,l=parseInt(a,10),s=n.charCodeAt(0)-65,c=t[l][s];if(null!==c){const{ship:t}=c;return t.hit(),r.push(e),t}return o.push(e),r.push(e),null},getMissedAttacks:()=>o,getAttackedCoordinates:()=>r,allShipsSunk:()=>n().every((e=>e.isSunk())),reset:()=>{t.forEach(((e,r)=>{e.forEach(((e,o)=>{t[r][o]=null}))})),r=[],o=[]}}},l=(e,t,r)=>{const n=new Set,a=(e,t)=>{const[r,n]=o.r.convertToIndices(e);let a=r,l=n;switch(t){case"up":a-=1;break;case"down":a+=1;break;case"left":l-=1;break;case"right":l+=1}return o.r.convertToAlphanumeric([a,l])},l=()=>{const e=["up","down","left","right"];if(t){const r=e.indexOf(t);-1!==r&&(e.splice(r,1),e.push(t),console.log(t))}else for(let t=e.length-1;t>0;t-=1){const r=Math.floor(Math.random()*(t+1));[e[t],e[r]]=[e[r],e[t]]}return e};return{name:e,lastHitCoordinate:r,currentDirection:t,attack:(e,t,r)=>{const s=e.getGrid().length,c=o.r.getAllValidCoordinates(s);let i="";if(t&&r){const o=l();for(const l of o)if(i=a(t,l),c.includes(i)&&!n.has(i)&&!e.getAttackedCoordinates().includes(i))return n.add(i),t=i,r=l,i}do{i=c[Math.floor(Math.random()*c.length)]}while(n.has(i)||e.getAttackedCoordinates().includes(i));return n.add(i),i},getAttackedSet:()=>n,clearSet:()=>{n.clear()}}}},555:(e,t,r)=>{r.d(t,{U:()=>n,r:()=>o});const o=(()=>{const e=[],t=([e,t])=>String.fromCharCode(t+65)+e;return{convertToIndices:e=>{const t=e.charCodeAt(0)-65;return[parseInt(e.slice(1),10),t]},convertToAlphanumeric:t,getAllValidCoordinates:r=>{for(let o=0;o<r;o+=1)for(let n=0;n<r;n+=1){const r=t([o,n]);e.push(r)}return e}}})(),n={shipTypes:[{type:"carrier",length:5},{type:"battleship",length:4},{type:"destroyer",length:3},{type:"submarine",length:3},{type:"patrol boat",length:2}],toggleModal:(e,t)=>{const r=e,o="show"===t?"flex":"none";e.closest(".overlay").style.display=o,r.style.display=o}}}},t={};function r(o){var n=t[o];if(void 0!==n)return n.exports;var a=t[o]={exports:{}};return e[o](a,a.exports,r),a.exports}r.d=(e,t)=>{for(var o in t)r.o(t,o)&&!r.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r(380),r(776)})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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RyxFQUFPQyxLQUMxQixNQUFNQyxFQUFlRixFQUdmRyxFQUEwQixTQUFYRixFQUFvQixPQUFTLE9BRGxDRCxFQUFNSSxRQUFRLFlBR3RCQyxNQUFNQyxRQUFVSCxFQUN4QkQsRUFBYUcsTUFBTUMsUUFBVUgsQ0FBWSxFLEdDL0N6Q0ksRUFBMkIsQ0FBQyxFQUdoQyxTQUFTQyxFQUFvQkMsR0FFNUIsSUFBSUMsRUFBZUgsRUFBeUJFLEdBQzVDLFFBQXFCRSxJQUFqQkQsRUFDSCxPQUFPQSxFQUFhRSxRQUdyQixJQUFJQyxFQUFTTixFQUF5QkUsR0FBWSxDQUdqREcsUUFBUyxDQUFDLEdBT1gsT0FIQUUsRUFBb0JMLEdBQVVJLEVBQVFBLEVBQU9ELFFBQVNKLEdBRy9DSyxFQUFPRCxPQUNmLENDckJBSixFQUFvQk8sRUFBSSxDQUFDSCxFQUFTSSxLQUNqQyxJQUFJLElBQUlDLEtBQU9ELEVBQ1hSLEVBQW9CVSxFQUFFRixFQUFZQyxLQUFTVCxFQUFvQlUsRUFBRU4sRUFBU0ssSUFDNUVFLE9BQU9DLGVBQWVSLEVBQVNLLEVBQUssQ0FBRUksWUFBWSxFQUFNQyxJQUFLTixFQUFXQyxJQUUxRSxFQ05EVCxFQUFvQlUsRUFBSSxDQUFDSyxFQUFLQyxJQUFVTCxPQUFPTSxVQUFVQyxlQUFlQyxLQUFLSixFQUFLQyxHQ0VsRmhCLEVBQW9CLEtBRU1BLEVBQW9CLEkiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9iYXR0bGVzaGlwLy4vc3JjL3JlbmRlci5qcyIsIndlYnBhY2s6Ly9iYXR0bGVzaGlwLy4vc3JjL2FwcC5qcyIsIndlYnBhY2s6Ly9iYXR0bGVzaGlwLy4vc3JjL2ZhY3Rvcmllcy5qcyIsIndlYnBhY2s6Ly9iYXR0bGVzaGlwLy4vc3JjL3V0aWxzLmpzIiwid2VicGFjazovL2JhdHRsZXNoaXAvd2VicGFjay9ib290c3RyYXAiLCJ3ZWJwYWNrOi8vYmF0dGxlc2hpcC93ZWJwYWNrL3J1bnRpbWUvZGVmaW5lIHByb3BlcnR5IGdldHRlcnMiLCJ3ZWJwYWNrOi8vYmF0dGxlc2hpcC93ZWJwYWNrL3J1bnRpbWUvaGFzT3duUHJvcGVydHkgc2hvcnRoYW5kIiwid2VicGFjazovL2JhdHRsZXNoaXAvd2VicGFjay9zdGFydHVwIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEZhY3RvcnlIZWxwZXJzIH0gZnJvbSBcIi4vdXRpbHNcIjtcblxuY29uc3QgUmVuZGVyZXIgPSAoKCkgPT4ge1xuICBjb25zdCByZW5kZXJHYW1lYm9hcmQgPSAoY29udGFpbmVyRWxlbWVudCkgPT4ge1xuICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoY29udGFpbmVyRWxlbWVudCk7XG5cbiAgICBjb250YWluZXIudGV4dENvbnRlbnQgPSBcIlwiO1xuXG4gICAgZm9yIChsZXQgcm93ID0gMDsgcm93IDwgMTA7IHJvdyArPSAxKSB7XG4gICAgICBmb3IgKGxldCBjb2wgPSAwOyBjb2wgPCAxMDsgY29sICs9IDEpIHtcbiAgICAgICAgY29uc3QgY29vcmRpbmF0ZSA9IEZhY3RvcnlIZWxwZXJzLmNvbnZlcnRUb0FscGhhbnVtZXJpYyhbcm93LCBjb2xdKTtcbiAgICAgICAgY29uc3Qgc3F1YXJlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcbiAgICAgICAgc3F1YXJlLmNsYXNzTGlzdC5hZGQoXCJzcXVhcmVcIik7XG4gICAgICAgIHNxdWFyZS5kYXRhc2V0LmNvb3JkaW5hdGUgPSBjb29yZGluYXRlO1xuXG4gICAgICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChzcXVhcmUpO1xuICAgICAgfVxuICAgIH1cbiAgfTtcblxuICBjb25zdCBhdHRhY2hFdmVudExpc3RlbmVycyA9IChjb250YWluZXJFbGVtZW50LCBldmVudExpc3RlbmVycykgPT4ge1xuICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoY29udGFpbmVyRWxlbWVudCk7XG5cbiAgICBjb250YWluZXIucXVlcnlTZWxlY3RvckFsbChcIi5zcXVhcmVcIikuZm9yRWFjaCgoc3F1YXJlKSA9PiB7XG4gICAgICBldmVudExpc3RlbmVycy5mb3JFYWNoKChsaXN0ZW5lcikgPT4ge1xuICAgICAgICBzcXVhcmUuYWRkRXZlbnRMaXN0ZW5lcihsaXN0ZW5lci5ldmVudFR5cGUsIGxpc3RlbmVyLmhhbmRsZXIpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH07XG5cbiAgY29uc3Qgc2V0V2lubmVySGVhZGluZyA9ICh3aW5uZXIpID0+IHtcbiAgICBjb25zdCB3aW5uZXJIZWFkaW5nID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIiN3aW5uZXJcIik7XG4gICAgd2lubmVySGVhZGluZy50ZXh0Q29udGVudCA9IGAke3dpbm5lcn0gd29uIWA7XG4gIH07XG5cbiAgY29uc3QgY2xlYXJHYW1lYm9hcmQgPSAoY29udGFpbmVyRWxlbWVudCkgPT4ge1xuICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoY29udGFpbmVyRWxlbWVudCk7XG4gICAgY29uc3Qgc3F1YXJlcyA9IGNvbnRhaW5lci5xdWVyeVNlbGVjdG9yQWxsKFwiLnNxdWFyZVwiKTtcblxuICAgIHNxdWFyZXMuZm9yRWFjaCgoc3F1YXJlKSA9PiB7XG4gICAgICBjb25zdCByZXNldFNxdWFyZSA9IHNxdWFyZTtcbiAgICAgIHJlc2V0U3F1YXJlLmNsYXNzTmFtZSA9IFwic3F1YXJlXCI7IC8vIFJlc2V0IHRoZSBjbGFzc05hbWUgdG8gcmVtb3ZlIGFsbCBjbGFzc2VzXG4gICAgfSk7XG4gIH07XG5cbiAgcmV0dXJuIHtcbiAgICByZW5kZXJHYW1lYm9hcmQsXG4gICAgYXR0YWNoRXZlbnRMaXN0ZW5lcnMsXG4gICAgc2V0V2lubmVySGVhZGluZyxcbiAgICBjbGVhckdhbWVib2FyZCxcbiAgfTtcbn0pKCk7XG5cbmV4cG9ydCBkZWZhdWx0IFJlbmRlcmVyO1xuIiwiLyogZXNsaW50LWRpc2FibGUgbm8tcmVzdHJpY3RlZC1zeW50YXggKi9cbi8qIGVzbGludC1kaXNhYmxlIG5vLWxvbmVseS1pZiAqL1xuaW1wb3J0IHsgQXBwSGVscGVycywgRmFjdG9yeUhlbHBlcnMgfSBmcm9tIFwiLi91dGlsc1wiO1xuaW1wb3J0IFJlbmRlcmVyIGZyb20gXCIuL3JlbmRlclwiO1xuaW1wb3J0IHsgU2hpcEZhY3RvcnksIEdhbWVib2FyZEZhY3RvcnksIFBsYXllckZhY3RvcnkgfSBmcm9tIFwiLi9mYWN0b3JpZXNcIjtcblxuLy8gMS4gLS0tXG4vLyAyLiAtLS1cbi8vIDMuIC0tLVxuLy8gNC4gU3R5bGUgPT4gTW9kYWxzID0+IE1lZGlhIHF1ZXJpZXNcbi8vIDUuIFB1c2ggdG8gZ2gtcGFnZXMgYW5kIGFkZCByZWFkbWVcblxuY29uc3QgQ29udHJvbGxlciA9ICgoKSA9PiB7XG4gIGNvbnN0IHBsYXllckdhbWVib2FyZCA9IEdhbWVib2FyZEZhY3RvcnkoKTtcbiAgY29uc3QgY29tcHV0ZXJHYW1lYm9hcmQgPSBHYW1lYm9hcmRGYWN0b3J5KCk7XG5cbiAgY29uc3QgY29tcHV0ZXIgPSBQbGF5ZXJGYWN0b3J5KFwiY29tcHV0ZXJcIik7XG5cbiAgbGV0IGN1cnJlbnRTaGlwSW5kZXggPSAwO1xuICBsZXQgc2hpcFBsYWNlbWVudE1vZGUgPSB0cnVlO1xuICBsZXQgaXNWZXJ0aWNhbCA9IGZhbHNlO1xuICBsZXQgd2lubmVyID0gbnVsbDtcblxuICBjb25zdCBwbGFjZUNvbXB1dGVyU2hpcHMgPSAoKSA9PiB7XG4gICAgZm9yIChjb25zdCBzaGlwVHlwZSBvZiBBcHBIZWxwZXJzLnNoaXBUeXBlcykge1xuICAgICAgY29uc3QgeyBsZW5ndGggfSA9IHNoaXBUeXBlO1xuICAgICAgY29uc3Qgc2hpcCA9IFNoaXBGYWN0b3J5KGxlbmd0aCk7XG5cbiAgICAgIGNvbnN0IGdyaWRTaXplID0gMTA7XG4gICAgICBsZXQgY29vcmRpbmF0ZXM7XG4gICAgICBsZXQgcGxhY2VkID0gZmFsc2U7XG5cbiAgICAgIHdoaWxlICghcGxhY2VkKSB7XG4gICAgICAgIC8vIEdlbmVyYXRlIHJhbmRvbSBzdGFydFJvdyBhbmQgc3RhcnRDb2wgd2l0aGluIHRoZSBncmlkIGJvdW5kYXJpZXNcbiAgICAgICAgY29uc3Qgc3RhcnRSb3cgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBncmlkU2l6ZSk7XG4gICAgICAgIGNvbnN0IHN0YXJ0Q29sID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogZ3JpZFNpemUpO1xuXG4gICAgICAgIC8vIFJhbmRvbWx5IGNob29zZSB3aGV0aGVyIHRoZSBzaGlwIHdpbGwgYmUgcGxhY2VkIHZlcnRpY2FsbHkgb3IgaG9yaXpvbnRhbGx5XG4gICAgICAgIGlzVmVydGljYWwgPSBNYXRoLnJhbmRvbSgpIDwgMC41O1xuXG4gICAgICAgIGlmIChpc1ZlcnRpY2FsICYmIHN0YXJ0Um93ICsgbGVuZ3RoIDw9IGdyaWRTaXplKSB7XG4gICAgICAgICAgLy8gR2VuZXJhdGUgdGhlIGNvb3JkaW5hdGVzIGZvciBhIHZlcnRpY2FsbHkgcGxhY2VkIHNoaXBcbiAgICAgICAgICBjb29yZGluYXRlcyA9IEFycmF5LmZyb20oeyBsZW5ndGggfSwgKF8sIGkpID0+IFtcbiAgICAgICAgICAgIHN0YXJ0Um93ICsgaSxcbiAgICAgICAgICAgIHN0YXJ0Q29sLFxuICAgICAgICAgIF0pO1xuICAgICAgICB9IGVsc2UgaWYgKCFpc1ZlcnRpY2FsICYmIHN0YXJ0Q29sICsgbGVuZ3RoIDw9IGdyaWRTaXplKSB7XG4gICAgICAgICAgLy8gR2VuZXJhdGUgdGhlIGNvb3JkaW5hdGVzIGZvciBhIGhvcml6b250YWxseSBwbGFjZWQgc2hpcFxuICAgICAgICAgIGNvb3JkaW5hdGVzID0gQXJyYXkuZnJvbSh7IGxlbmd0aCB9LCAoXywgaSkgPT4gW1xuICAgICAgICAgICAgc3RhcnRSb3csXG4gICAgICAgICAgICBzdGFydENvbCArIGksXG4gICAgICAgICAgXSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY29vcmRpbmF0ZXMpIHtcbiAgICAgICAgICAvLyBDaGVjayBpZiB0aGUgc2hpcCBjYW4gYmUgcGxhY2VkIGF0IHRoZSBnZW5lcmF0ZWQgY29vcmRpbmF0ZXNcbiAgICAgICAgICBwbGFjZWQgPSBjb21wdXRlckdhbWVib2FyZC5wbGFjZVNoaXAoc2hpcCwgY29vcmRpbmF0ZXMpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9O1xuXG4gIGNvbnN0IHNoaXBQbGFjZW1lbnRIYW5kbGVyID0gKGUpID0+IHtcbiAgICBpZiAoc2hpcFBsYWNlbWVudE1vZGUpIHtcbiAgICAgIGNvbnN0IHNxdWFyZSA9IGUudGFyZ2V0O1xuICAgICAgY29uc3QgeyBjb29yZGluYXRlIH0gPSBzcXVhcmUuZGF0YXNldDtcbiAgICAgIGNvbnN0IHsgbGVuZ3RoIH0gPSBBcHBIZWxwZXJzLnNoaXBUeXBlc1tjdXJyZW50U2hpcEluZGV4XTtcblxuICAgICAgY29uc3QgW3N0YXJ0Um93LCBzdGFydENvbF0gPSBGYWN0b3J5SGVscGVycy5jb252ZXJ0VG9JbmRpY2VzKGNvb3JkaW5hdGUpO1xuXG4gICAgICAvLyBHZW5lcmF0ZSBhbiBhcnJheSBvZiBzaGlwIGNvb3JkaW5hdGVzIGJhc2VkIG9uIHRoZSBzaGlwIGxlbmd0aFxuICAgICAgY29uc3Qgc2hpcENvb3JkaW5hdGVzID0gQXJyYXkuZnJvbSh7IGxlbmd0aCB9LCAoXywgaSkgPT4ge1xuICAgICAgICAvLyBDYWxjdWxhdGUgdGhlIHJvdyBjb29yZGluYXRlIGJhc2VkIG9uIHZlcnRpY2FsIG9yIGhvcml6b250YWwgcGxhY2VtZW50XG4gICAgICAgIGNvbnN0IHJvdyA9IGlzVmVydGljYWwgPyBzdGFydFJvdyArIGkgOiBzdGFydFJvdztcbiAgICAgICAgLy8gQ2FsY3VsYXRlIHRoZSBjb2x1bW4gY29vcmRpbmF0ZSBiYXNlZCBvbiB2ZXJ0aWNhbCBvciBob3Jpem9udGFsIHBsYWNlbWVudFxuICAgICAgICBjb25zdCBjb2wgPSBpc1ZlcnRpY2FsID8gc3RhcnRDb2wgOiBzdGFydENvbCArIGk7XG4gICAgICAgIHJldHVybiBbcm93LCBjb2xdOyAvLyBSZXR1cm4gdGhlIGNvb3JkaW5hdGUgcGFpclxuICAgICAgfSk7XG5cbiAgICAgIC8vIEF0dGVtcHQgdG8gcGxhY2UgdGhlIHNoaXAgb24gdGhlIHBsYXllciBnYW1lYm9hcmRcbiAgICAgIGNvbnN0IHNoaXAgPSBTaGlwRmFjdG9yeShsZW5ndGgpO1xuICAgICAgY29uc3QgcGxhY2VkID0gcGxheWVyR2FtZWJvYXJkLnBsYWNlU2hpcChzaGlwLCBzaGlwQ29vcmRpbmF0ZXMpO1xuXG4gICAgICBpZiAocGxhY2VkKSB7XG4gICAgICAgIC8vIElmIHNoaXAgcGxhY2VtZW50IGlzIHN1Y2Nlc3NmdWxcbiAgICAgICAgc3F1YXJlLmNsYXNzTGlzdC5hZGQoXCJwbGFjZWRcIik7XG4gICAgICAgIHNoaXBDb29yZGluYXRlcy5mb3JFYWNoKChbcm93LCBjb2xdKSA9PiB7XG4gICAgICAgICAgY29uc3QgcGxhY2VkU3F1YXJlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcbiAgICAgICAgICAgIGBbZGF0YS1jb29yZGluYXRlPVwiJHtGYWN0b3J5SGVscGVycy5jb252ZXJ0VG9BbHBoYW51bWVyaWMoW1xuICAgICAgICAgICAgICByb3csXG4gICAgICAgICAgICAgIGNvbCxcbiAgICAgICAgICAgIF0pfVwiXWBcbiAgICAgICAgICApO1xuICAgICAgICAgIHBsYWNlZFNxdWFyZS5jbGFzc0xpc3QuYWRkKFwicGxhY2VkXCIpO1xuICAgICAgICAgIGNvbnN0IGluaXRpYWxTcXVhcmUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFxuICAgICAgICAgICAgYC5nYW1lYm9hcmQuaW5pdGlhbCBbZGF0YS1jb29yZGluYXRlPVwiJHtGYWN0b3J5SGVscGVycy5jb252ZXJ0VG9BbHBoYW51bWVyaWMoXG4gICAgICAgICAgICAgIFtyb3csIGNvbF1cbiAgICAgICAgICAgICl9XCJdYFxuICAgICAgICAgICk7XG4gICAgICAgICAgaW5pdGlhbFNxdWFyZS5jbGFzc0xpc3QuYWRkKFwicGxhY2VkXCIpO1xuICAgICAgICB9KTtcblxuICAgICAgICBjdXJyZW50U2hpcEluZGV4ICs9IDE7IC8vIEluY3JlbWVudCB0aGUgY3VycmVudFNoaXBJbmRleCB0byBtb3ZlIHRvIHRoZSBuZXh0IHNoaXBcblxuICAgICAgICBpZiAoY3VycmVudFNoaXBJbmRleCA9PT0gQXBwSGVscGVycy5zaGlwVHlwZXMubGVuZ3RoKSB7XG4gICAgICAgICAgLy8gSWYgYWxsIHNoaXBzIGhhdmUgYmVlbiBwbGFjZWRcbiAgICAgICAgICBzaGlwUGxhY2VtZW50TW9kZSA9IGZhbHNlOyAvLyBEaXNhYmxlIHNoaXAgcGxhY2VtZW50IG1vZGVcbiAgICAgICAgICBwbGFjZUNvbXB1dGVyU2hpcHMoKTsgLy8gUGxhY2UgdGhlIGNvbXB1dGVyJ3Mgc2hpcHNcbiAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgIC8vIFNldCBhIHRpbWVvdXQgdG8gZGVsYXkgaGlkaW5nIHRoZSBpbml0aWFsIHNoaXAgcGxhY2VtZW50IG1vZGFsXG4gICAgICAgICAgICBBcHBIZWxwZXJzLnRvZ2dsZU1vZGFsKFxuICAgICAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiLm1vZGFsLmluaXRpYWxcIiksXG4gICAgICAgICAgICAgIFwiaGlkZVwiXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH0sIDUwMCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8gSWYgdGhlcmUgYXJlIHN0aWxsIHNoaXBzIHRvIGJlIHBsYWNlZFxuICAgICAgICAgIC8vIEdldCB0aGUgdHlwZSBvZiB0aGUgbmV4dCBzaGlwIGJhc2VkIG9uIHRoZSBjdXJyZW50U2hpcEluZGV4XG4gICAgICAgICAgY29uc3QgbmV4dFNoaXBUeXBlID0gQXBwSGVscGVycy5zaGlwVHlwZXNbY3VycmVudFNoaXBJbmRleF0udHlwZTtcbiAgICAgICAgICAvLyBVcGRhdGUgdGhlIHNoaXAgdHlwZSB0ZXh0IG9uIHRoZSBVSVxuICAgICAgICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIuc2hpcC10eXBlXCIpLnRleHRDb250ZW50ID0gbmV4dFNoaXBUeXBlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9O1xuXG4gIGNvbnN0IGdhbWVib2FyZEhvdmVySGFuZGxlciA9IChlKSA9PiB7XG4gICAgaWYgKHNoaXBQbGFjZW1lbnRNb2RlKSB7XG4gICAgICAvLyBDaGVjayBpZiBzaGlwIHBsYWNlbWVudCBtb2RlIGlzIGFjdGl2ZVxuICAgICAgY29uc3Qgc3F1YXJlID0gZS50YXJnZXQ7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcHJlZmVyLWRlc3RydWN0dXJpbmdcbiAgICAgIGNvbnN0IGNvb3JkaW5hdGUgPSBzcXVhcmUuZGF0YXNldC5jb29yZGluYXRlO1xuICAgICAgY29uc3QgeyBsZW5ndGggfSA9IEFwcEhlbHBlcnMuc2hpcFR5cGVzW2N1cnJlbnRTaGlwSW5kZXhdOyAvLyBHZXQgdGhlIGxlbmd0aCBvZiB0aGUgc2hpcFxuXG4gICAgICBjb25zdCBbc3RhcnRSb3csIHN0YXJ0Q29sXSA9IEZhY3RvcnlIZWxwZXJzLmNvbnZlcnRUb0luZGljZXMoY29vcmRpbmF0ZSk7XG4gICAgICAvLyBHZW5lcmF0ZSBhbiBhcnJheSBvZiBob3ZlcmVkIHNxdWFyZXMgYmFzZWQgb24gdGhlIHNoaXAgbGVuZ3RoXG4gICAgICBjb25zdCBob3ZlcmVkU3F1YXJlcyA9IEFycmF5LmZyb20oeyBsZW5ndGggfSwgKF8sIGkpID0+IHtcbiAgICAgICAgLy8gQ2FsY3VsYXRlIHRoZSByb3cgY29vcmRpbmF0ZSBiYXNlZCBvbiB2ZXJ0aWNhbCBvciBob3Jpem9udGFsIHBsYWNlbWVudFxuICAgICAgICBjb25zdCByb3cgPSBpc1ZlcnRpY2FsID8gc3RhcnRSb3cgKyBpIDogc3RhcnRSb3c7XG4gICAgICAgIC8vIENhbGN1bGF0ZSB0aGUgY29sdW1uIGNvb3JkaW5hdGUgYmFzZWQgb24gdmVydGljYWwgb3IgaG9yaXpvbnRhbCBwbGFjZW1lbnRcbiAgICAgICAgY29uc3QgY29sID0gaXNWZXJ0aWNhbCA/IHN0YXJ0Q29sIDogc3RhcnRDb2wgKyBpO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGluaXRpYWxTcXVhcmU6IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXG4gICAgICAgICAgICBgLmdhbWVib2FyZC5pbml0aWFsIFtkYXRhLWNvb3JkaW5hdGU9XCIke0ZhY3RvcnlIZWxwZXJzLmNvbnZlcnRUb0FscGhhbnVtZXJpYyhcbiAgICAgICAgICAgICAgW3JvdywgY29sXVxuICAgICAgICAgICAgKX1cIl1gXG4gICAgICAgICAgKSxcbiAgICAgICAgfTtcbiAgICAgIH0pO1xuXG4gICAgICBob3ZlcmVkU3F1YXJlcy5mb3JFYWNoKCh7IGluaXRpYWxTcXVhcmUgfSkgPT4ge1xuICAgICAgICAvLyBJdGVyYXRlIG92ZXIgdGhlIGhvdmVyZWQgc3F1YXJlc1xuICAgICAgICBpZiAoaW5pdGlhbFNxdWFyZSkge1xuICAgICAgICAgIC8vIENoZWNrIGlmIHRoZSBpbml0aWFsIHNxdWFyZSBleGlzdHNcbiAgICAgICAgICBpbml0aWFsU3F1YXJlLmNsYXNzTGlzdC5hZGQoXCJob3ZlcmVkXCIpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH07XG5cbiAgY29uc3QgZ2FtZWJvYXJkTW91c2VMZWF2ZUhhbmRsZXIgPSAoKSA9PiB7XG4gICAgY29uc3QgaG92ZXJlZFNxdWFyZXMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKFwiLmdhbWVib2FyZCAuaG92ZXJlZFwiKTtcbiAgICBob3ZlcmVkU3F1YXJlcy5mb3JFYWNoKChob3ZlcmVkU3F1YXJlKSA9PiB7XG4gICAgICBob3ZlcmVkU3F1YXJlLmNsYXNzTGlzdC5yZW1vdmUoXCJob3ZlcmVkXCIpO1xuICAgIH0pO1xuICB9O1xuXG4gIGNvbnN0IGNvbXB1dGVyQXR0YWNrID0gKCkgPT4ge1xuICAgIGlmICghc2hpcFBsYWNlbWVudE1vZGUpIHtcbiAgICAgIGNvbnN0IGNvb3JkaW5hdGUgPSBjb21wdXRlci5hdHRhY2soXG4gICAgICAgIHBsYXllckdhbWVib2FyZCxcbiAgICAgICAgY29tcHV0ZXIubGFzdEhpdENvb3JkaW5hdGUsXG4gICAgICAgIGNvbXB1dGVyLmN1cnJlbnREaXJlY3Rpb25cbiAgICAgICk7XG4gICAgICAvLyBSZWNlaXZlIHRoZSBhdHRhY2sgb24gdGhlIHBsYXllcidzIGdhbWVib2FyZCBhbmQgZ2V0IHRoZSBhdHRhY2tlZCBzaGlwIChpZiBhbnkpXG4gICAgICBjb25zdCBhdHRhY2tlZFNoaXAgPSBwbGF5ZXJHYW1lYm9hcmQucmVjZWl2ZUF0dGFjayhjb29yZGluYXRlKTtcblxuICAgICAgY29uc3Qgc3F1YXJlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcbiAgICAgICAgYC5nYW1lYm9hcmQucGxheWVyIFtkYXRhLWNvb3JkaW5hdGU9XCIke2Nvb3JkaW5hdGV9XCJdYFxuICAgICAgKTsgLy8gR2V0IHRoZSBjb3JyZXNwb25kaW5nIHNxdWFyZSBlbGVtZW50IG9uIHRoZSBwbGF5ZXIncyBnYW1lYm9hcmRcblxuICAgICAgaWYgKGF0dGFja2VkU2hpcCkge1xuICAgICAgICBzcXVhcmUuY2xhc3NMaXN0LmFkZChcImhpdFwiKTtcbiAgICAgICAgLy8gSWYgdGhlcmUgd2FzIGEgaGl0LCB1cGRhdGUgdGhlIGxhc3RIaXRDb29yZGluYXRlIGFuZCBjdXJyZW50RGlyZWN0aW9uXG4gICAgICAgIGNvbXB1dGVyLmxhc3RIaXRDb29yZGluYXRlID0gY29vcmRpbmF0ZTtcbiAgICAgICAgLy8gVG8ga2VlcCB0aGUgY29tcHV0ZXIncyBhdHRhY2sgY29uc2lzdGVudCwgc2V0IHRoZSBjdXJyZW50RGlyZWN0aW9uIGluaXRpYWxseSB0byBcInVwXCJcbiAgICAgICAgaWYgKGNvbXB1dGVyLmN1cnJlbnREaXJlY3Rpb24gPT09IG51bGwpIHtcbiAgICAgICAgICBjb21wdXRlci5jdXJyZW50RGlyZWN0aW9uID0gXCJ1cFwiO1xuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKCFhdHRhY2tlZFNoaXAgJiYgY29tcHV0ZXIubGFzdEhpdENvb3JkaW5hdGUpIHtcbiAgICAgICAgc3F1YXJlLmNsYXNzTGlzdC5hZGQoXCJtaXNzXCIpO1xuICAgICAgfSBlbHNlIGlmICghYXR0YWNrZWRTaGlwICYmICFjb21wdXRlci5sYXN0SGl0Q29vcmRpbmF0ZSkge1xuICAgICAgICBzcXVhcmUuY2xhc3NMaXN0LmFkZChcIm1pc3NcIik7XG4gICAgICAgIC8vIElmIHRoZXJlIHdhcyBhIG1pc3MsIHJlc2V0IHRoZSBsYXN0SGl0Q29vcmRpbmF0ZSBhbmQgY3VycmVudERpcmVjdGlvblxuICAgICAgICBjb21wdXRlci5sYXN0SGl0Q29vcmRpbmF0ZSA9IG51bGw7XG4gICAgICAgIGNvbXB1dGVyLmN1cnJlbnREaXJlY3Rpb24gPSBudWxsO1xuICAgICAgfVxuICAgICAgaWYgKHBsYXllckdhbWVib2FyZC5hbGxTaGlwc1N1bmsoKSkge1xuICAgICAgICB3aW5uZXIgPSBcIlRoZSBjb21wdXRlclwiO1xuICAgICAgICBSZW5kZXJlci5zZXRXaW5uZXJIZWFkaW5nKHdpbm5lcik7XG4gICAgICAgIEFwcEhlbHBlcnMudG9nZ2xlTW9kYWwoXG4gICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIi5tb2RhbC5lbmRnYW1lXCIpLFxuICAgICAgICAgIFwic2hvd1wiXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICB9O1xuXG4gIGNvbnN0IHBsYXllckF0dGFjayA9IChlKSA9PiB7XG4gICAgaWYgKCFzaGlwUGxhY2VtZW50TW9kZSkge1xuICAgICAgY29uc3Qgc3F1YXJlID0gZS50YXJnZXQ7IC8vIEdldCB0aGUgY2xpY2tlZCBzcXVhcmUgZWxlbWVudFxuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHByZWZlci1kZXN0cnVjdHVyaW5nXG4gICAgICBjb25zdCBjb29yZGluYXRlID0gc3F1YXJlLmRhdGFzZXQuY29vcmRpbmF0ZTtcbiAgICAgIC8vIENvbnZlcnQgdGhlIHJvdyBhbmQgY29sdW1uIGluZGljZXMgdG8gYW4gYWxwaGFudW1lcmljIGNvb3JkaW5hdGVcblxuICAgICAgLy8gQ2hlY2sgaWYgdGhlIGNvb3JkaW5hdGUgaGFzIG5vdCBiZWVuIHByZXZpb3VzbHkgYXR0YWNrZWRcbiAgICAgIGlmICghY29tcHV0ZXJHYW1lYm9hcmQuZ2V0QXR0YWNrZWRDb29yZGluYXRlcygpLmluY2x1ZGVzKGNvb3JkaW5hdGUpKSB7XG4gICAgICAgIC8vIFJlY2VpdmUgdGhlIGF0dGFjayBvbiB0aGUgY29tcHV0ZXIncyBnYW1lYm9hcmQgYW5kIGdldCB0aGUgYXR0YWNrZWQgc2hpcCAoaWYgYW55KVxuICAgICAgICBjb25zdCBhdHRhY2tlZFNoaXAgPSBjb21wdXRlckdhbWVib2FyZC5yZWNlaXZlQXR0YWNrKGNvb3JkaW5hdGUpO1xuXG4gICAgICAgIGlmIChhdHRhY2tlZFNoaXApIHtcbiAgICAgICAgICBzcXVhcmUuY2xhc3NMaXN0LmFkZChcImhpdFwiKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBzcXVhcmUuY2xhc3NMaXN0LmFkZChcIm1pc3NcIik7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY29tcHV0ZXJHYW1lYm9hcmQuYWxsU2hpcHNTdW5rKCkpIHtcbiAgICAgICAgICB3aW5uZXIgPSBcIllvdVwiO1xuICAgICAgICAgIFJlbmRlcmVyLnNldFdpbm5lckhlYWRpbmcod2lubmVyKTtcbiAgICAgICAgICBBcHBIZWxwZXJzLnRvZ2dsZU1vZGFsKFxuICAgICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIi5tb2RhbC5lbmRnYW1lXCIpLFxuICAgICAgICAgICAgXCJzaG93XCJcbiAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgY29tcHV0ZXJBdHRhY2soKTsgLy8gUGVyZm9ybSB0aGUgY29tcHV0ZXIncyBhdHRhY2tcbiAgICAgIH1cbiAgICB9XG4gIH07XG5cbiAgY29uc3Qgcm90YXRlU2hpcHMgPSAoKSA9PiB7XG4gICAgaXNWZXJ0aWNhbCA9ICFpc1ZlcnRpY2FsO1xuICB9O1xuXG4gIGNvbnN0IGV2ZW50TGlzdGVuZXJzID0gW1xuICAgIHsgZXZlbnRUeXBlOiBcIm1vdXNlb3ZlclwiLCBoYW5kbGVyOiBnYW1lYm9hcmRIb3ZlckhhbmRsZXIgfSxcbiAgICB7IGV2ZW50VHlwZTogXCJtb3VzZWxlYXZlXCIsIGhhbmRsZXI6IGdhbWVib2FyZE1vdXNlTGVhdmVIYW5kbGVyIH0sXG4gICAgeyBldmVudFR5cGU6IFwiY2xpY2tcIiwgaGFuZGxlcjogc2hpcFBsYWNlbWVudEhhbmRsZXIgfSxcbiAgXTtcblxuICBjb25zdCByZXNldEdhbWUgPSAoKSA9PiB7XG4gICAgLy8gUmVzZXQgZ2FtZS1yZWxhdGVkIHZhcmlhYmxlc1xuICAgIGN1cnJlbnRTaGlwSW5kZXggPSAwO1xuICAgIHNoaXBQbGFjZW1lbnRNb2RlID0gdHJ1ZTtcbiAgICBpc1ZlcnRpY2FsID0gZmFsc2U7XG4gICAgd2lubmVyID0gbnVsbDtcbiAgICBjb21wdXRlci5sYXN0SGl0Q29vcmRpbmF0ZSA9IG51bGw7XG4gICAgY29tcHV0ZXIuY3VycmVudERpcmVjdGlvbiA9IG51bGw7XG5cbiAgICAvLyBSZXNldCBnYW1lYm9hcmQgb2JqZWN0c1xuICAgIHBsYXllckdhbWVib2FyZC5yZXNldCgpO1xuICAgIGNvbXB1dGVyR2FtZWJvYXJkLnJlc2V0KCk7XG5cbiAgICAvLyBDbGVhciBjb21wdXRlcnMgYXR0YWNrZWRDb29yZGluYXRlcyBzZXRcbiAgICBjb21wdXRlci5jbGVhclNldCgpO1xuXG4gICAgLy8gUmVtb3ZlIGhpdCBhbmQgbWlzcyBjbGFzc2VzIGZyb20gYWxsIHNxdWFyZXNcbiAgICBSZW5kZXJlci5jbGVhckdhbWVib2FyZChcIi5nYW1lYm9hcmQuaW5pdGlhbFwiKTtcbiAgICBSZW5kZXJlci5jbGVhckdhbWVib2FyZChcIi5nYW1lYm9hcmQucGxheWVyXCIpO1xuICAgIFJlbmRlcmVyLmNsZWFyR2FtZWJvYXJkKFwiLmdhbWVib2FyZC5jb21wdXRlclwiKTtcblxuICAgIC8vIFJlc2V0IHNoaXBUeXBlc1xuICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIuc2hpcC10eXBlXCIpLnRleHRDb250ZW50ID1cbiAgICAgIEFwcEhlbHBlcnMuc2hpcFR5cGVzWzBdLnR5cGU7XG4gIH07XG5cbiAgY29uc3QgaW5pdCA9ICgpID0+IHtcbiAgICBBcHBIZWxwZXJzLnRvZ2dsZU1vZGFsKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIubW9kYWwuZW5kZ2FtZVwiKSwgXCJoaWRlXCIpO1xuICAgIFJlbmRlcmVyLnJlbmRlckdhbWVib2FyZChcIi5nYW1lYm9hcmQuaW5pdGlhbFwiKTtcbiAgICBSZW5kZXJlci5yZW5kZXJHYW1lYm9hcmQoXCIuZ2FtZWJvYXJkLnBsYXllclwiKTtcbiAgICBSZW5kZXJlci5yZW5kZXJHYW1lYm9hcmQoXCIuZ2FtZWJvYXJkLmNvbXB1dGVyXCIpO1xuICAgIFJlbmRlcmVyLmF0dGFjaEV2ZW50TGlzdGVuZXJzKFwiLmdhbWVib2FyZC5pbml0aWFsXCIsIGV2ZW50TGlzdGVuZXJzKTtcblxuICAgIGNvbnN0IGNvbXB1dGVyU3F1YXJlcyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoXG4gICAgICBcIi5nYW1lYm9hcmQuY29tcHV0ZXIgLnNxdWFyZVwiXG4gICAgKTtcbiAgICBjb21wdXRlclNxdWFyZXMuZm9yRWFjaCgoc3F1YXJlKSA9PiB7XG4gICAgICBzcXVhcmUuYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIHBsYXllckF0dGFjayk7XG4gICAgfSk7XG5cbiAgICBjb25zdCByb3RhdGVCdG4gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiI3JvdGF0ZUJ0blwiKTtcbiAgICByb3RhdGVCdG4uYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsIHJvdGF0ZVNoaXBzKTtcblxuICAgIGNvbnN0IHBsYXlBZ2FpbkJ1dHRvbiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIjbmV3R2FtZVwiKTtcbiAgICBwbGF5QWdhaW5CdXR0b24uYWRkRXZlbnRMaXN0ZW5lcihcImNsaWNrXCIsICgpID0+IHtcbiAgICAgIHJlc2V0R2FtZSgpO1xuICAgICAgQXBwSGVscGVycy50b2dnbGVNb2RhbChkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiLm1vZGFsLmVuZGdhbWVcIiksIFwiaGlkZVwiKTtcbiAgICAgIEFwcEhlbHBlcnMudG9nZ2xlTW9kYWwoZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIi5tb2RhbC5pbml0aWFsXCIpLCBcInNob3dcIik7XG4gICAgfSk7XG4gIH07XG5cbiAgcmV0dXJuIHtcbiAgICBpbml0LFxuICB9O1xufSkoKTtcblxuQ29udHJvbGxlci5pbml0KCk7XG4iLCIvKiBlc2xpbnQtZGlzYWJsZSBuby1wYXJhbS1yZWFzc2lnbiAqL1xuaW1wb3J0IHsgRmFjdG9yeUhlbHBlcnMgfSBmcm9tIFwiLi91dGlsc1wiO1xuXG5leHBvcnQgY29uc3QgU2hpcEZhY3RvcnkgPSAobGVuZ3RoKSA9PiB7XG4gIGxldCBoaXRzID0gMDtcblxuICBjb25zdCBoaXQgPSAoKSA9PiB7XG4gICAgaGl0cyArPSAxO1xuICB9O1xuXG4gIGNvbnN0IGlzU3VuayA9ICgpID0+IGhpdHMgPj0gbGVuZ3RoOyAvLyBSZXR1cm4gdHJ1ZSBpZiBoaXRzIGlzIGVxdWFsIHRvIG9yIGdyZWF0ZXIgdGhhbiBsZW5ndGhcblxuICByZXR1cm4ge1xuICAgIGxlbmd0aCxcbiAgICBoaXQsXG4gICAgaXNTdW5rLFxuICAgIGdldCBoaXRzKCkge1xuICAgICAgLy8gR2V0dGVyIGZ1bmN0aW9uIGZvciBoaXRzLiBVc2luZyBmdW5jdGlvbiBkZWNsYXJhdGlvbiB0byBlbnN1cmUgaXQgaGFzIGFjY2VzcyB0byB0aGVcbiAgICAgIC8vIGBoaXRzYCB2YXJpYWJsZSBkeW5hbWljYWxseSwgc2luY2UgZnVuY3Rpb24gZGVjbGFyYXRpb25zIGFyZSBob2lzdGVkIGFuZCBjYW4gYmUgdXNlZFxuICAgICAgLy8gYmVmb3JlIHRoZXkgYXJlIGRlZmluZWQuIFRoaXMgYWxsb3dzIGFjY2Vzc2luZyB0aGUgY3VycmVudCB2YWx1ZSBvZiBgaGl0c2AgZXZlbiBiZWZvcmVcbiAgICAgIC8vIGNhbGxpbmcgdGhlIGBoaXRgIGZ1bmN0aW9uXG4gICAgICByZXR1cm4gaGl0cztcbiAgICB9LFxuICB9O1xufTtcblxuZXhwb3J0IGNvbnN0IEdhbWVib2FyZEZhY3RvcnkgPSAoKSA9PiB7XG4gIGNvbnN0IGdyaWRTaXplID0gMTA7XG4gIGNvbnN0IGdyaWQgPSBBcnJheS5mcm9tKHsgbGVuZ3RoOiBncmlkU2l6ZSB9LCAoKSA9PlxuICAgIEFycmF5KGdyaWRTaXplKS5maWxsKG51bGwpXG4gICk7XG5cbiAgbGV0IGF0dGFja2VkQ29vcmRpbmF0ZXMgPSBbXTtcbiAgbGV0IG1pc3NlZEF0dGFja3MgPSBbXTtcblxuICBjb25zdCBnZXRHcmlkID0gKCkgPT4gZ3JpZDtcblxuICBjb25zdCBwbGFjZVNoaXAgPSAoc2hpcCwgY29vcmRpbmF0ZXMpID0+IHtcbiAgICAvLyBDaGVjayBpZiBhbGwgY29vcmRpbmF0ZXMgYXJlIHdpdGhpbiB0aGUgYm91bmRhcmllcyBvZiB0aGUgZ3JpZFxuICAgIGNvbnN0IHdpdGhpbkJvdW5kYXJpZXMgPSBjb29yZGluYXRlcy5ldmVyeShcbiAgICAgIChbcm93LCBjb2xdKSA9PiByb3cgPj0gMCAmJiByb3cgPCBncmlkU2l6ZSAmJiBjb2wgPj0gMCAmJiBjb2wgPCBncmlkU2l6ZVxuICAgICk7XG5cbiAgICAvLyBDaGVjayBpZiB0aGVyZSBhcmUgYW55IGNvbmZsaWN0cyB3aXRoIGV4aXN0aW5nIHNoaXAgcGxhY2VtZW50cyBvbiB0aGUgZ3JpZFxuICAgIGNvbnN0IGNvbmZsaWN0cyA9IGNvb3JkaW5hdGVzLnNvbWUoKFtyb3csIGNvbF0pID0+IGdyaWRbcm93XVtjb2xdICE9PSBudWxsKTtcblxuICAgIC8vIENoZWNrIGlmIHRoZXJlIGFyZSBhbnkgYWRqYWNlbnQgY29uZmxpY3RzIHdpdGggZXhpc3Rpbmcgc2hpcCBwbGFjZW1lbnRzIG9uIHRoZSBncmlkXG4gICAgY29uc3QgYWRqYWNlbnRDb25mbGljdHMgPSBjb29yZGluYXRlcy5zb21lKChbcm93LCBjb2xdKSA9PiB7XG4gICAgICAvLyBEZWZpbmUgdGhlIGFkamFjZW50IGNvb3JkaW5hdGVzIGFyb3VuZCB0aGUgY3VycmVudCBjb29yZGluYXRlXG4gICAgICBjb25zdCBhZGphY2VudENvb3JkaW5hdGVzID0gW1xuICAgICAgICBbcm93IC0gMSwgY29sXSwgLy8gVXBcbiAgICAgICAgW3JvdyArIDEsIGNvbF0sIC8vIERvd25cbiAgICAgICAgW3JvdywgY29sIC0gMV0sIC8vIExlZnRcbiAgICAgICAgW3JvdywgY29sICsgMV0sIC8vIFJpZ2h0XG4gICAgICAgIFtyb3cgLSAxLCBjb2wgLSAxXSwgLy8gRGlhZ29uYWwgVXAtTGVmdFxuICAgICAgICBbcm93IC0gMSwgY29sICsgMV0sIC8vIERpYWdvbmFsIFVwLVJpZ2h0XG4gICAgICAgIFtyb3cgKyAxLCBjb2wgLSAxXSwgLy8gRGlhZ29uYWwgRG93bi1MZWZ0XG4gICAgICAgIFtyb3cgKyAxLCBjb2wgKyAxXSwgLy8gRGlhZ29uYWwgRG93bi1SaWdodFxuICAgICAgXTtcblxuICAgICAgLy8gQ2hlY2sgaWYgYW55IGFkamFjZW50IGNvb3JkaW5hdGUgaGFzIGEgc2hpcCBwbGFjZWQgb24gaXRcbiAgICAgIHJldHVybiBhZGphY2VudENvb3JkaW5hdGVzLnNvbWUoXG4gICAgICAgIChbYWRqUm93LCBhZGpDb2xdKSA9PlxuICAgICAgICAgIGFkalJvdyA+PSAwICYmXG4gICAgICAgICAgYWRqUm93IDwgZ3JpZFNpemUgJiZcbiAgICAgICAgICBhZGpDb2wgPj0gMCAmJlxuICAgICAgICAgIGFkakNvbCA8IGdyaWRTaXplICYmXG4gICAgICAgICAgZ3JpZFthZGpSb3ddPy5bYWRqQ29sXSAhPT0gbnVsbFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIC8vIElmIHRoZSBzaGlwIHBsYWNlbWVudCBpcyB3aXRoaW4gZ3JpZCBib3VuZGFyaWVzLCBoYXMgbm8gY29uZmxpY3RzLCBhbmQgbm8gYWRqYWNlbnQgY29uZmxpY3RzLi4uXG4gICAgaWYgKHdpdGhpbkJvdW5kYXJpZXMgJiYgIWNvbmZsaWN0cyAmJiAhYWRqYWNlbnRDb25mbGljdHMpIHtcbiAgICAgIC8vIENyZWF0ZSBhbiBvYmplY3QgY29udGFpbmluZyBzaGlwIGluZm9ybWF0aW9uIGFuZCBjb29yZGluYXRlc1xuICAgICAgY29uc3Qgc2hpcEluZm8gPSB7XG4gICAgICAgIHNoaXAsXG4gICAgICAgIGNvb3JkaW5hdGVzLFxuICAgICAgfTtcblxuICAgICAgLy8gUGxhY2UgdGhlIHNoaXAgb24gdGhlIGdyaWQgYnkgdXBkYXRpbmcgdGhlIGNvcnJlc3BvbmRpbmcgY2VsbHNcbiAgICAgIHNoaXBJbmZvLmNvb3JkaW5hdGVzLmZvckVhY2goKFtyb3csIGNvbF0pID0+IHtcbiAgICAgICAgZ3JpZFtyb3ddW2NvbF0gPSBzaGlwSW5mbztcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4gdHJ1ZTsgLy8gU2hpcCBwbGFjZW1lbnQgc3VjY2Vzc2Z1bFxuICAgIH1cblxuICAgIHJldHVybiBmYWxzZTsgLy8gT3RoZXJ3aXNlLCBzaGlwIHBsYWNlbWVudCBmYWlsZWRcbiAgfTtcblxuICBjb25zdCBnZXRTaGlwcyA9ICgpID0+IHtcbiAgICBjb25zdCBzaGlwcyA9IFtdO1xuXG4gICAgLy8gSXRlcmF0ZSB0aHJvdWdoIGVhY2ggY2VsbCBvZiB0aGUgZ3JpZFxuICAgIGZvciAobGV0IHJvdyA9IDA7IHJvdyA8IGdyaWRTaXplOyByb3cgKz0gMSkge1xuICAgICAgZm9yIChsZXQgY29sID0gMDsgY29sIDwgZ3JpZFNpemU7IGNvbCArPSAxKSB7XG4gICAgICAgIGNvbnN0IGNlbGwgPSBncmlkW3Jvd11bY29sXTtcbiAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIGNlbGwgY29udGFpbnMgYSBzaGlwIGFuZCBpdCdzIG5vdCBhbHJlYWR5IGluY2x1ZGVkIGluIHRoZSBzaGlwcyBhcnJheVxuICAgICAgICBpZiAoXG4gICAgICAgICAgY2VsbCAhPT0gbnVsbCAmJlxuICAgICAgICAgIGNlbGwuc2hpcCAmJlxuICAgICAgICAgICFzaGlwcy5pbmNsdWRlcyhjZWxsLnNoaXApICYmXG4gICAgICAgICAgIWNlbGwuc2hpcC5pc1N1bmsoKVxuICAgICAgICApIHtcbiAgICAgICAgICAvLyBBZGQgdGhlIHNoaXAgdG8gdGhlIHNoaXBzIGFycmF5XG4gICAgICAgICAgc2hpcHMucHVzaChjZWxsLnNoaXApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHNoaXBzO1xuICB9O1xuXG4gIGNvbnN0IGdldEFsbFNoaXBzID0gKCkgPT4ge1xuICAgIGNvbnN0IHNoaXBzID0gW107XG5cbiAgICAvLyBJdGVyYXRlIHRocm91Z2ggZWFjaCBjZWxsIG9mIHRoZSBncmlkXG4gICAgZm9yIChsZXQgcm93ID0gMDsgcm93IDwgZ3JpZFNpemU7IHJvdyArPSAxKSB7XG4gICAgICBmb3IgKGxldCBjb2wgPSAwOyBjb2wgPCBncmlkU2l6ZTsgY29sICs9IDEpIHtcbiAgICAgICAgY29uc3QgY2VsbCA9IGdyaWRbcm93XVtjb2xdO1xuICAgICAgICAvLyBDaGVjayBpZiB0aGUgY2VsbCBjb250YWlucyBhIHNoaXAgYW5kIGl0J3Mgbm90IGFscmVhZHkgaW5jbHVkZWQgaW4gdGhlIHNoaXBzIGFycmF5XG4gICAgICAgIGlmIChjZWxsICE9PSBudWxsICYmIGNlbGwuc2hpcCAmJiAhc2hpcHMuaW5jbHVkZXMoY2VsbC5zaGlwKSkge1xuICAgICAgICAgIC8vIEFkZCB0aGUgc2hpcCB0byB0aGUgc2hpcHMgYXJyYXlcbiAgICAgICAgICBzaGlwcy5wdXNoKGNlbGwuc2hpcCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gc2hpcHM7XG4gIH07XG5cbiAgY29uc3QgZ2V0U2hpcENvb3JkaW5hdGVzID0gKHNoaXApID0+IHtcbiAgICBjb25zdCBjb29yZGluYXRlcyA9IFtdO1xuXG4gICAgLy8gSXRlcmF0ZSB0aHJvdWdoIGVhY2ggY2VsbCBvZiB0aGUgZ3JpZFxuICAgIGZvciAobGV0IHJvdyA9IDA7IHJvdyA8IGdyaWRTaXplOyByb3cgKz0gMSkge1xuICAgICAgZm9yIChsZXQgY29sID0gMDsgY29sIDwgZ3JpZFNpemU7IGNvbCArPSAxKSB7XG4gICAgICAgIGNvbnN0IGNlbGwgPSBncmlkW3Jvd11bY29sXTtcbiAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIGNlbGwgZXhpc3RzIGFuZCBjb250YWlucyB0aGUgc3BlY2lmaWVkIHNoaXBcbiAgICAgICAgaWYgKGNlbGwgJiYgY2VsbC5zaGlwID09PSBzaGlwKSB7XG4gICAgICAgICAgLy8gQWRkIHRvIGNvb3JkaW5hdGVzIGFycmF5XG4gICAgICAgICAgY29vcmRpbmF0ZXMucHVzaChbcm93LCBjb2xdKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBjb29yZGluYXRlcztcbiAgfTtcblxuICBjb25zdCByZWNlaXZlQXR0YWNrID0gKGNvb3JkaW5hdGUpID0+IHtcbiAgICBjb25zdCBbY29sdW1uTGV0dGVyLCByb3dOdW1iZXJdID0gY29vcmRpbmF0ZTtcbiAgICBjb25zdCByb3cgPSBwYXJzZUludChyb3dOdW1iZXIsIDEwKTtcbiAgICBjb25zdCBjb2wgPSBjb2x1bW5MZXR0ZXIuY2hhckNvZGVBdCgwKSAtIDY1O1xuICAgIGNvbnN0IGNlbGwgPSBncmlkW3Jvd11bY29sXTtcblxuICAgIGlmIChjZWxsICE9PSBudWxsKSB7XG4gICAgICAvLyBTaGlwIGF0IGNvb3JkaW5hdGUsIGl0J3MgYSBoaXRcbiAgICAgIGNvbnN0IHsgc2hpcCB9ID0gY2VsbDtcbiAgICAgIHNoaXAuaGl0KCk7IC8vIEluY3JlbWVudCBoaXQgY291bnQgb2YgdGhlIHNoaXBcbiAgICAgIGF0dGFja2VkQ29vcmRpbmF0ZXMucHVzaChjb29yZGluYXRlKTtcbiAgICAgIHJldHVybiBzaGlwOyAvLyBSZXR1cm4gdGhlIHNoaXAgb2JqZWN0IHdoZW4gaXQgaXMgaGl0XG4gICAgfVxuICAgIC8vIE5vIHNoaXAgYXQgY29vcmRpbmF0ZSwgaXQncyBhIG1pc3NcbiAgICBtaXNzZWRBdHRhY2tzLnB1c2goY29vcmRpbmF0ZSk7XG4gICAgYXR0YWNrZWRDb29yZGluYXRlcy5wdXNoKGNvb3JkaW5hdGUpO1xuICAgIHJldHVybiBudWxsOyAvLyBSZXR1cm4gbnVsbCB3aGVuIGl0J3MgYSBtaXNzXG4gIH07XG5cbiAgY29uc3QgYWxsU2hpcHNTdW5rID0gKCkgPT4ge1xuICAgIGNvbnN0IHNoaXBzID0gZ2V0U2hpcHMoKTsgLy8gUmV0cmlldmUgYWxsIHRoZSBzaGlwcyBvbiB0aGUgZ2FtZWJvYXJkXG5cbiAgICAvLyBDaGVjayBpZiBhbGwgc2hpcHMgYXJlIHN1bmssIHJldHVybiB0cnVlIGlmIHllcywgYW5kIHJldHVybiBmYWxzZSBpZiBub1xuICAgIGNvbnN0IHJlc3VsdCA9IHNoaXBzLmV2ZXJ5KChzaGlwKSA9PiBzaGlwLmlzU3VuaygpKTtcblxuICAgIHJldHVybiByZXN1bHQ7XG4gIH07XG5cbiAgY29uc3QgcmVzZXQgPSAoKSA9PiB7XG4gICAgLy8gQ2xlYXIgdGhlIGdyaWQgYnkgc2V0dGluZyBhbGwgY2VsbHMgdG8gbnVsbFxuICAgIGdyaWQuZm9yRWFjaCgocm93LCByb3dJbmRleCkgPT4ge1xuICAgICAgcm93LmZvckVhY2goKF8sIGNvbEluZGV4KSA9PiB7XG4gICAgICAgIGdyaWRbcm93SW5kZXhdW2NvbEluZGV4XSA9IG51bGw7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIC8vIFJlYXNzaWduIGVtcHR5IGFycmF5cyB0byBjbGVhciB0aGUgY29udGVudHMgb2YgYXR0YWNrZWRDb29yZGluYXRlcyBhbmQgbWlzc2VkQXR0YWNrc1xuICAgIGF0dGFja2VkQ29vcmRpbmF0ZXMgPSBbXTtcbiAgICBtaXNzZWRBdHRhY2tzID0gW107XG4gIH07XG5cbiAgY29uc3QgZ2V0TWlzc2VkQXR0YWNrcyA9ICgpID0+IG1pc3NlZEF0dGFja3M7XG5cbiAgY29uc3QgZ2V0QXR0YWNrZWRDb29yZGluYXRlcyA9ICgpID0+IGF0dGFja2VkQ29vcmRpbmF0ZXM7XG5cbiAgcmV0dXJuIHtcbiAgICBnZXRHcmlkLFxuICAgIHBsYWNlU2hpcCxcbiAgICBnZXRTaGlwcyxcbiAgICBnZXRBbGxTaGlwcyxcbiAgICBnZXRTaGlwQ29vcmRpbmF0ZXMsXG4gICAgcmVjZWl2ZUF0dGFjayxcbiAgICBnZXRNaXNzZWRBdHRhY2tzLFxuICAgIGdldEF0dGFja2VkQ29vcmRpbmF0ZXMsXG4gICAgYWxsU2hpcHNTdW5rLFxuICAgIHJlc2V0LFxuICB9O1xufTtcblxuZXhwb3J0IGNvbnN0IFBsYXllckZhY3RvcnkgPSAobmFtZSwgY3VycmVudERpcmVjdGlvbiwgbGFzdEhpdENvb3JkaW5hdGUpID0+IHtcbiAgY29uc3QgYXR0YWNrZWRDb29yZGluYXRlcyA9IG5ldyBTZXQoKTsgLy8gU2V0IHRvIGtlZXAgdHJhY2sgb2YgYXR0YWNrZWQgY29vcmRpbmF0ZXNcblxuICBjb25zdCBnZXROZXh0Q29vcmRpbmF0ZUluRGlyZWN0aW9uID0gKGNvb3JkaW5hdGUsIGRpcmVjdGlvbikgPT4ge1xuICAgIGNvbnN0IFtyb3csIGNvbF0gPSBGYWN0b3J5SGVscGVycy5jb252ZXJ0VG9JbmRpY2VzKGNvb3JkaW5hdGUpO1xuXG4gICAgbGV0IG5leHRSb3cgPSByb3c7XG4gICAgbGV0IG5leHRDb2wgPSBjb2w7XG5cbiAgICAvLyBVcGRhdGUgdGhlIG5leHRSb3cgYW5kIG5leHRDb2wgYmFzZWQgb24gdGhlIGdpdmVuIGRpcmVjdGlvblxuICAgIHN3aXRjaCAoZGlyZWN0aW9uKSB7XG4gICAgICBjYXNlIFwidXBcIjpcbiAgICAgICAgbmV4dFJvdyAtPSAxO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgXCJkb3duXCI6XG4gICAgICAgIG5leHRSb3cgKz0gMTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFwibGVmdFwiOlxuICAgICAgICBuZXh0Q29sIC09IDE7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBcInJpZ2h0XCI6XG4gICAgICAgIG5leHRDb2wgKz0gMTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICBicmVhaztcbiAgICB9XG5cbiAgICByZXR1cm4gRmFjdG9yeUhlbHBlcnMuY29udmVydFRvQWxwaGFudW1lcmljKFtuZXh0Um93LCBuZXh0Q29sXSk7XG4gIH07XG5cbiAgY29uc3QgZ2V0TmV4dERpcmVjdGlvbnMgPSAoKSA9PiB7XG4gICAgY29uc3QgZGlyZWN0aW9ucyA9IFtcInVwXCIsIFwiZG93blwiLCBcImxlZnRcIiwgXCJyaWdodFwiXTtcbiAgICBpZiAoIWN1cnJlbnREaXJlY3Rpb24pIHtcbiAgICAgIC8vIElmIGN1cnJlbnREaXJlY3Rpb24gaXMgbm90IHNldCwgc2h1ZmZsZSB0aGUgZGlyZWN0aW9ucyB0byB0cnkgdGhlbSBpbiByYW5kb20gb3JkZXJcbiAgICAgIGZvciAobGV0IGkgPSBkaXJlY3Rpb25zLmxlbmd0aCAtIDE7IGkgPiAwOyBpIC09IDEpIHtcbiAgICAgICAgY29uc3QgaiA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIChpICsgMSkpO1xuICAgICAgICBbZGlyZWN0aW9uc1tpXSwgZGlyZWN0aW9uc1tqXV0gPSBbZGlyZWN0aW9uc1tqXSwgZGlyZWN0aW9uc1tpXV07XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIElmIGN1cnJlbnREaXJlY3Rpb24gaXMgc2V0LCBtb3ZlIGl0IHRvIHRoZSBlbmQgb2YgdGhlIGxpc3QsIHNvIGl0IHdpbGwgdHJ5IG90aGVyIGRpcmVjdGlvbnMgZmlyc3RcbiAgICAgIGNvbnN0IGluZGV4ID0gZGlyZWN0aW9ucy5pbmRleE9mKGN1cnJlbnREaXJlY3Rpb24pO1xuICAgICAgaWYgKGluZGV4ICE9PSAtMSkge1xuICAgICAgICBkaXJlY3Rpb25zLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgIGRpcmVjdGlvbnMucHVzaChjdXJyZW50RGlyZWN0aW9uKTtcbiAgICAgICAgY29uc29sZS5sb2coY3VycmVudERpcmVjdGlvbik7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBkaXJlY3Rpb25zO1xuICB9O1xuXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1zaGFkb3dcbiAgY29uc3QgYXR0YWNrID0gKGVuZW15R2FtZWJvYXJkLCBsYXN0SGl0Q29vcmRpbmF0ZSwgY3VycmVudERpcmVjdGlvbikgPT4ge1xuICAgIGNvbnN0IGdyaWRTaXplID0gZW5lbXlHYW1lYm9hcmQuZ2V0R3JpZCgpLmxlbmd0aDtcbiAgICBjb25zdCB2YWxpZENvb3JkaW5hdGVzID0gRmFjdG9yeUhlbHBlcnMuZ2V0QWxsVmFsaWRDb29yZGluYXRlcyhncmlkU2l6ZSk7XG5cbiAgICBsZXQgY29vcmRpbmF0ZSA9IFwiXCI7XG5cbiAgICBpZiAobGFzdEhpdENvb3JkaW5hdGUgJiYgY3VycmVudERpcmVjdGlvbikge1xuICAgICAgLy8gR2V0IHRoZSBuZXh0IGRpcmVjdGlvbnMgdG8gdHJ5XG4gICAgICBjb25zdCBkaXJlY3Rpb25zVG9UcnkgPSBnZXROZXh0RGlyZWN0aW9ucygpO1xuXG4gICAgICAvLyBUcnkgZWFjaCBkaXJlY3Rpb24gdW50aWwgYSB2YWxpZCBjb29yZGluYXRlIGlzIGZvdW5kXG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tcmVzdHJpY3RlZC1zeW50YXhcbiAgICAgIGZvciAoY29uc3QgZGlyZWN0aW9uIG9mIGRpcmVjdGlvbnNUb1RyeSkge1xuICAgICAgICBjb29yZGluYXRlID0gZ2V0TmV4dENvb3JkaW5hdGVJbkRpcmVjdGlvbihsYXN0SGl0Q29vcmRpbmF0ZSwgZGlyZWN0aW9uKTtcbiAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIG5leHQgY29vcmRpbmF0ZSBpbiB0aGUgY3VycmVudCBkaXJlY3Rpb24gaXMgYSB2YWxpZCwgdW5hdHRhY2tlZCBjb29yZGluYXRlXG4gICAgICAgIGlmIChcbiAgICAgICAgICB2YWxpZENvb3JkaW5hdGVzLmluY2x1ZGVzKGNvb3JkaW5hdGUpICYmXG4gICAgICAgICAgIWF0dGFja2VkQ29vcmRpbmF0ZXMuaGFzKGNvb3JkaW5hdGUpICYmXG4gICAgICAgICAgIWVuZW15R2FtZWJvYXJkLmdldEF0dGFja2VkQ29vcmRpbmF0ZXMoKS5pbmNsdWRlcyhjb29yZGluYXRlKVxuICAgICAgICApIHtcbiAgICAgICAgICAvLyBBZGQgdGhlIGF0dGFja2VkIGNvb3JkaW5hdGUgdG8gdGhlIHBsYXllcidzIHNldCBvZiBhdHRhY2tlZCBjb29yZGluYXRlc1xuICAgICAgICAgIGF0dGFja2VkQ29vcmRpbmF0ZXMuYWRkKGNvb3JkaW5hdGUpO1xuICAgICAgICAgIC8vIFVwZGF0ZSBsYXN0SGl0Q29vcmRpbmF0ZSBhbmQgY3VycmVudERpcmVjdGlvblxuXG4gICAgICAgICAgbGFzdEhpdENvb3JkaW5hdGUgPSBjb29yZGluYXRlO1xuICAgICAgICAgIGN1cnJlbnREaXJlY3Rpb24gPSBkaXJlY3Rpb247XG4gICAgICAgICAgcmV0dXJuIGNvb3JkaW5hdGU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBJZiBubyB2YWxpZCBuZXh0IGNvb3JkaW5hdGUgaW4gdGhlIGN1cnJlbnQgZGlyZWN0aW9uLCBvciBpZiB0aGUgbGFzdEhpdENvb3JkaW5hdGUgb3IgY3VycmVudERpcmVjdGlvbiBpcyBub3Qgc2V0LFxuICAgIC8vIGF0dGFjayByYW5kb21seSBsaWtlIGJlZm9yZVxuICAgIGRvIHtcbiAgICAgIGNvbnN0IHJhbmRvbUluZGV4ID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogdmFsaWRDb29yZGluYXRlcy5sZW5ndGgpO1xuICAgICAgY29vcmRpbmF0ZSA9IHZhbGlkQ29vcmRpbmF0ZXNbcmFuZG9tSW5kZXhdO1xuICAgIH0gd2hpbGUgKFxuICAgICAgYXR0YWNrZWRDb29yZGluYXRlcy5oYXMoY29vcmRpbmF0ZSkgfHxcbiAgICAgIGVuZW15R2FtZWJvYXJkLmdldEF0dGFja2VkQ29vcmRpbmF0ZXMoKS5pbmNsdWRlcyhjb29yZGluYXRlKVxuICAgICk7XG5cbiAgICAvLyBBZGQgdGhlIGF0dGFja2VkIGNvb3JkaW5hdGUgdG8gdGhlIHBsYXllcidzIHNldCBvZiBhdHRhY2tlZCBjb29yZGluYXRlc1xuICAgIGF0dGFja2VkQ29vcmRpbmF0ZXMuYWRkKGNvb3JkaW5hdGUpO1xuXG4gICAgcmV0dXJuIGNvb3JkaW5hdGU7XG4gIH07XG5cbiAgY29uc3QgZ2V0QXR0YWNrZWRTZXQgPSAoKSA9PiBhdHRhY2tlZENvb3JkaW5hdGVzO1xuXG4gIGNvbnN0IGNsZWFyU2V0ID0gKCkgPT4ge1xuICAgIGF0dGFja2VkQ29vcmRpbmF0ZXMuY2xlYXIoKTtcbiAgfTtcblxuICByZXR1cm4ge1xuICAgIG5hbWUsXG4gICAgbGFzdEhpdENvb3JkaW5hdGUsXG4gICAgY3VycmVudERpcmVjdGlvbixcbiAgICBhdHRhY2ssXG4gICAgZ2V0QXR0YWNrZWRTZXQsXG4gICAgY2xlYXJTZXQsXG4gIH07XG59O1xuIiwiZXhwb3J0IGNvbnN0IEZhY3RvcnlIZWxwZXJzID0gKCgpID0+IHtcbiAgY29uc3QgdmFsaWRDb29yZGluYXRlcyA9IFtdO1xuXG4gIGNvbnN0IGNvbnZlcnRUb0luZGljZXMgPSAoY29vcmRpbmF0ZSkgPT4ge1xuICAgIGNvbnN0IGNvbHVtbiA9IGNvb3JkaW5hdGUuY2hhckNvZGVBdCgwKSAtIDY1OyAvLyBDb252ZXJ0IGNvbHVtbiBsZXR0ZXIgdG8gaW5kZXhcbiAgICBjb25zdCByb3cgPSBwYXJzZUludChjb29yZGluYXRlLnNsaWNlKDEpLCAxMCk7IC8vIENvbnZlcnQgcm93IG51bWJlciB0byBpbmRleCB3aXRoIHJhZGl4IDEwXG4gICAgcmV0dXJuIFtyb3csIGNvbHVtbl07XG4gIH07XG5cbiAgY29uc3QgY29udmVydFRvQWxwaGFudW1lcmljID0gKFtyb3csIGNvbHVtbl0pID0+IHtcbiAgICBjb25zdCBjb29yZGluYXRlID0gU3RyaW5nLmZyb21DaGFyQ29kZShjb2x1bW4gKyA2NSk7IC8vIENvbnZlcnQgY29sdW1uIGluZGV4IHRvIGxldHRlclxuICAgIHJldHVybiBjb29yZGluYXRlICsgcm93OyAvLyBDb252ZXJ0IHJvdyBpbmRleCB0byBudW1iZXJcbiAgfTtcblxuICBjb25zdCBnZXRBbGxWYWxpZENvb3JkaW5hdGVzID0gKGdyaWRTaXplKSA9PiB7XG4gICAgZm9yIChsZXQgcm93ID0gMDsgcm93IDwgZ3JpZFNpemU7IHJvdyArPSAxKSB7XG4gICAgICBmb3IgKGxldCBjb2wgPSAwOyBjb2wgPCBncmlkU2l6ZTsgY29sICs9IDEpIHtcbiAgICAgICAgY29uc3QgYWxwaGFudW1lcmljQ29vcmRpbmF0ZSA9IGNvbnZlcnRUb0FscGhhbnVtZXJpYyhbcm93LCBjb2xdKTtcbiAgICAgICAgdmFsaWRDb29yZGluYXRlcy5wdXNoKGFscGhhbnVtZXJpY0Nvb3JkaW5hdGUpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB2YWxpZENvb3JkaW5hdGVzO1xuICB9O1xuXG4gIHJldHVybiB7XG4gICAgY29udmVydFRvSW5kaWNlcyxcbiAgICBjb252ZXJ0VG9BbHBoYW51bWVyaWMsXG4gICAgZ2V0QWxsVmFsaWRDb29yZGluYXRlcyxcbiAgfTtcbn0pKCk7XG5cbmV4cG9ydCBjb25zdCBBcHBIZWxwZXJzID0gKCgpID0+IHtcbiAgY29uc3Qgc2hpcFR5cGVzID0gW1xuICAgIHsgdHlwZTogXCJjYXJyaWVyXCIsIGxlbmd0aDogNSB9LFxuICAgIHsgdHlwZTogXCJiYXR0bGVzaGlwXCIsIGxlbmd0aDogNCB9LFxuICAgIHsgdHlwZTogXCJkZXN0cm95ZXJcIiwgbGVuZ3RoOiAzIH0sXG4gICAgeyB0eXBlOiBcInN1Ym1hcmluZVwiLCBsZW5ndGg6IDMgfSxcbiAgICB7IHR5cGU6IFwicGF0cm9sIGJvYXRcIiwgbGVuZ3RoOiAyIH0sXG4gIF07XG5cbiAgY29uc3QgdG9nZ2xlTW9kYWwgPSAobW9kYWwsIGNob2ljZSkgPT4ge1xuICAgIGNvbnN0IHRvZ2dsZWRNb2RhbCA9IG1vZGFsO1xuXG4gICAgY29uc3Qgb3ZlcmxheSA9IG1vZGFsLmNsb3Nlc3QoXCIub3ZlcmxheVwiKTtcbiAgICBjb25zdCBkaXNwbGF5VmFsdWUgPSBjaG9pY2UgPT09IFwic2hvd1wiID8gXCJmbGV4XCIgOiBcIm5vbmVcIjtcblxuICAgIG92ZXJsYXkuc3R5bGUuZGlzcGxheSA9IGRpc3BsYXlWYWx1ZTtcbiAgICB0b2dnbGVkTW9kYWwuc3R5bGUuZGlzcGxheSA9IGRpc3BsYXlWYWx1ZTtcbiAgfTtcblxuICByZXR1cm4ge1xuICAgIHNoaXBUeXBlcyxcbiAgICB0b2dnbGVNb2RhbCxcbiAgfTtcbn0pKCk7XG4iLCIvLyBUaGUgbW9kdWxlIGNhY2hlXG52YXIgX193ZWJwYWNrX21vZHVsZV9jYWNoZV9fID0ge307XG5cbi8vIFRoZSByZXF1aXJlIGZ1bmN0aW9uXG5mdW5jdGlvbiBfX3dlYnBhY2tfcmVxdWlyZV9fKG1vZHVsZUlkKSB7XG5cdC8vIENoZWNrIGlmIG1vZHVsZSBpcyBpbiBjYWNoZVxuXHR2YXIgY2FjaGVkTW9kdWxlID0gX193ZWJwYWNrX21vZHVsZV9jYWNoZV9fW21vZHVsZUlkXTtcblx0aWYgKGNhY2hlZE1vZHVsZSAhPT0gdW5kZWZpbmVkKSB7XG5cdFx0cmV0dXJuIGNhY2hlZE1vZHVsZS5leHBvcnRzO1xuXHR9XG5cdC8vIENyZWF0ZSBhIG5ldyBtb2R1bGUgKGFuZCBwdXQgaXQgaW50byB0aGUgY2FjaGUpXG5cdHZhciBtb2R1bGUgPSBfX3dlYnBhY2tfbW9kdWxlX2NhY2hlX19bbW9kdWxlSWRdID0ge1xuXHRcdC8vIG5vIG1vZHVsZS5pZCBuZWVkZWRcblx0XHQvLyBubyBtb2R1bGUubG9hZGVkIG5lZWRlZFxuXHRcdGV4cG9ydHM6IHt9XG5cdH07XG5cblx0Ly8gRXhlY3V0ZSB0aGUgbW9kdWxlIGZ1bmN0aW9uXG5cdF9fd2VicGFja19tb2R1bGVzX19bbW9kdWxlSWRdKG1vZHVsZSwgbW9kdWxlLmV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pO1xuXG5cdC8vIFJldHVybiB0aGUgZXhwb3J0cyBvZiB0aGUgbW9kdWxlXG5cdHJldHVybiBtb2R1bGUuZXhwb3J0cztcbn1cblxuIiwiLy8gZGVmaW5lIGdldHRlciBmdW5jdGlvbnMgZm9yIGhhcm1vbnkgZXhwb3J0c1xuX193ZWJwYWNrX3JlcXVpcmVfXy5kID0gKGV4cG9ydHMsIGRlZmluaXRpb24pID0+IHtcblx0Zm9yKHZhciBrZXkgaW4gZGVmaW5pdGlvbikge1xuXHRcdGlmKF9fd2VicGFja19yZXF1aXJlX18ubyhkZWZpbml0aW9uLCBrZXkpICYmICFfX3dlYnBhY2tfcmVxdWlyZV9fLm8oZXhwb3J0cywga2V5KSkge1xuXHRcdFx0T2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIGtleSwgeyBlbnVtZXJhYmxlOiB0cnVlLCBnZXQ6IGRlZmluaXRpb25ba2V5XSB9KTtcblx0XHR9XG5cdH1cbn07IiwiX193ZWJwYWNrX3JlcXVpcmVfXy5vID0gKG9iaiwgcHJvcCkgPT4gKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChvYmosIHByb3ApKSIsIi8vIHN0YXJ0dXBcbi8vIExvYWQgZW50cnkgbW9kdWxlIGFuZCByZXR1cm4gZXhwb3J0c1xuX193ZWJwYWNrX3JlcXVpcmVfXygzODApO1xuLy8gVGhpcyBlbnRyeSBtb2R1bGUgaXMgcmVmZXJlbmNlZCBieSBvdGhlciBtb2R1bGVzIHNvIGl0IGNhbid0IGJlIGlubGluZWRcbnZhciBfX3dlYnBhY2tfZXhwb3J0c19fID0gX193ZWJwYWNrX3JlcXVpcmVfXyg3NzYpO1xuIl0sIm5hbWVzIjpbImNvbnRhaW5lckVsZW1lbnQiLCJjb250YWluZXIiLCJkb2N1bWVudCIsInF1ZXJ5U2VsZWN0b3IiLCJ0ZXh0Q29udGVudCIsInJvdyIsImNvbCIsImNvb3JkaW5hdGUiLCJjb252ZXJ0VG9BbHBoYW51bWVyaWMiLCJzcXVhcmUiLCJjcmVhdGVFbGVtZW50IiwiY2xhc3NMaXN0IiwiYWRkIiwiZGF0YXNldCIsImFwcGVuZENoaWxkIiwiZXZlbnRMaXN0ZW5lcnMiLCJxdWVyeVNlbGVjdG9yQWxsIiwiZm9yRWFjaCIsImxpc3RlbmVyIiwiYWRkRXZlbnRMaXN0ZW5lciIsImV2ZW50VHlwZSIsImhhbmRsZXIiLCJ3aW5uZXIiLCJjbGFzc05hbWUiLCJwbGF5ZXJHYW1lYm9hcmQiLCJjb21wdXRlckdhbWVib2FyZCIsImNvbXB1dGVyIiwiY3VycmVudFNoaXBJbmRleCIsInNoaXBQbGFjZW1lbnRNb2RlIiwiaXNWZXJ0aWNhbCIsInBsYXllckF0dGFjayIsImUiLCJ0YXJnZXQiLCJnZXRBdHRhY2tlZENvb3JkaW5hdGVzIiwiaW5jbHVkZXMiLCJyZWNlaXZlQXR0YWNrIiwiYWxsU2hpcHNTdW5rIiwidG9nZ2xlTW9kYWwiLCJhdHRhY2siLCJsYXN0SGl0Q29vcmRpbmF0ZSIsImN1cnJlbnREaXJlY3Rpb24iLCJhdHRhY2tlZFNoaXAiLCJjb21wdXRlckF0dGFjayIsInJvdGF0ZVNoaXBzIiwibGVuZ3RoIiwic2hpcFR5cGVzIiwic3RhcnRSb3ciLCJzdGFydENvbCIsImNvbnZlcnRUb0luZGljZXMiLCJBcnJheSIsImZyb20iLCJfIiwiaSIsImluaXRpYWxTcXVhcmUiLCJob3ZlcmVkU3F1YXJlIiwicmVtb3ZlIiwic2hpcENvb3JkaW5hdGVzIiwic2hpcCIsInBsYWNlU2hpcCIsInNoaXBUeXBlIiwiZ3JpZFNpemUiLCJjb29yZGluYXRlcyIsInBsYWNlZCIsIk1hdGgiLCJmbG9vciIsInJhbmRvbSIsInBsYWNlQ29tcHV0ZXJTaGlwcyIsInNldFRpbWVvdXQiLCJuZXh0U2hpcFR5cGUiLCJ0eXBlIiwiaW5pdCIsInJlc2V0IiwiY2xlYXJTZXQiLCJTaGlwRmFjdG9yeSIsImhpdHMiLCJoaXQiLCJpc1N1bmsiLCJHYW1lYm9hcmRGYWN0b3J5IiwiZ3JpZCIsImZpbGwiLCJhdHRhY2tlZENvb3JkaW5hdGVzIiwibWlzc2VkQXR0YWNrcyIsImdldFNoaXBzIiwic2hpcHMiLCJjZWxsIiwicHVzaCIsImdldEdyaWQiLCJ3aXRoaW5Cb3VuZGFyaWVzIiwiZXZlcnkiLCJjb25mbGljdHMiLCJzb21lIiwiYWRqYWNlbnRDb25mbGljdHMiLCJhZGpSb3ciLCJhZGpDb2wiLCJzaGlwSW5mbyIsImdldEFsbFNoaXBzIiwiZ2V0U2hpcENvb3JkaW5hdGVzIiwiY29sdW1uTGV0dGVyIiwicm93TnVtYmVyIiwicGFyc2VJbnQiLCJjaGFyQ29kZUF0IiwiZ2V0TWlzc2VkQXR0YWNrcyIsInJvd0luZGV4IiwiY29sSW5kZXgiLCJQbGF5ZXJGYWN0b3J5IiwibmFtZSIsIlNldCIsImdldE5leHRDb29yZGluYXRlSW5EaXJlY3Rpb24iLCJkaXJlY3Rpb24iLCJuZXh0Um93IiwibmV4dENvbCIsImdldE5leHREaXJlY3Rpb25zIiwiZGlyZWN0aW9ucyIsImluZGV4IiwiaW5kZXhPZiIsInNwbGljZSIsImNvbnNvbGUiLCJsb2ciLCJqIiwiZW5lbXlHYW1lYm9hcmQiLCJ2YWxpZENvb3JkaW5hdGVzIiwiZ2V0QWxsVmFsaWRDb29yZGluYXRlcyIsImRpcmVjdGlvbnNUb1RyeSIsImhhcyIsImdldEF0dGFja2VkU2V0IiwiY2xlYXIiLCJGYWN0b3J5SGVscGVycyIsImNvbHVtbiIsIlN0cmluZyIsImZyb21DaGFyQ29kZSIsInNsaWNlIiwiYWxwaGFudW1lcmljQ29vcmRpbmF0ZSIsIkFwcEhlbHBlcnMiLCJtb2RhbCIsImNob2ljZSIsInRvZ2dsZWRNb2RhbCIsImRpc3BsYXlWYWx1ZSIsImNsb3Nlc3QiLCJzdHlsZSIsImRpc3BsYXkiLCJfX3dlYnBhY2tfbW9kdWxlX2NhY2hlX18iLCJfX3dlYnBhY2tfcmVxdWlyZV9fIiwibW9kdWxlSWQiLCJjYWNoZWRNb2R1bGUiLCJ1bmRlZmluZWQiLCJleHBvcnRzIiwibW9kdWxlIiwiX193ZWJwYWNrX21vZHVsZXNfXyIsImQiLCJkZWZpbml0aW9uIiwia2V5IiwibyIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZW51bWVyYWJsZSIsImdldCIsIm9iaiIsInByb3AiLCJwcm90b3R5cGUiLCJoYXNPd25Qcm9wZXJ0eSIsImNhbGwiXSwic291cmNlUm9vdCI6IiJ9