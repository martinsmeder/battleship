(()=>{"use strict";var e={380:(e,t,o)=>{var r=o(555);const a=e=>{const t=document.querySelector(e);t.textContent="";for(let e=0;e<10;e+=1)for(let o=0;o<10;o+=1){const r=document.createElement("div");r.classList.add("square"),r.dataset.row=e,r.dataset.col=o,t.appendChild(r)}},n=(e,t)=>{document.querySelector(e).querySelectorAll(".square").forEach((e=>{t.forEach((t=>{e.addEventListener(t.eventType,t.handler)}))}))};var s=o(776);(()=>{const e=(0,s.Br)(),t=(0,s.Br)(),o=(0,s.oP)("computer"),l=[{type:"carrier",length:5},{type:"battleship",length:4},{type:"destroyer",length:3},{type:"submarine",length:3},{type:"patrol boat",length:2}];let c=0,i=!0,d=!1;const u=a=>{if(!i){const n=a.target,s=parseInt(n.dataset.row,10),l=parseInt(n.dataset.col,10),c=r.r.convertToAlphanumeric([s,l]);if(!t.getAttackedCoordinates().includes(c)){const r=t.receiveAttack(c);r?(n.classList.add("hit"),console.log(`Player hit Computer at: ${c}`),r.isSunk()&&console.log(`Player sank Computer's ${r}!`)):(n.classList.add("miss"),console.log(`Player missed at: ${c}`)),t.allShipsSunk()&&console.log("Player wins!"),(()=>{if(!i){const t=o.attack(e);console.log(t)}})()}}},h=()=>{d=!d},p=[{eventType:"mouseover",handler:e=>{if(i){const t=e.target,o=parseInt(t.dataset.row,10),r=parseInt(t.dataset.col,10),{length:a}=l[c];Array.from({length:a},((e,t)=>{const a=d?o+t:o,n=d?r:r+t;return{initialSquare:document.querySelector(`.gameboard.initial [data-row="${a}"][data-col="${n}"]`)}})).forEach((({initialSquare:e})=>{e&&e.classList.add("hovered")}))}}},{eventType:"mouseleave",handler:()=>{document.querySelectorAll(".gameboard .hovered").forEach((e=>{e.classList.remove("hovered")}))}},{eventType:"click",handler:o=>{if(i){const a=o.target,n=parseInt(a.dataset.row,10),u=parseInt(a.dataset.col,10),{length:h}=l[c],p=Array.from({length:h},((e,t)=>[d?n+t:n,d?u:u+t])),g=(0,s._V)(h);if(e.placeShip(g,p))if(a.classList.add("placed"),p.forEach((([e,t])=>{document.querySelector(`[data-row="${e}"][data-col="${t}"]`).classList.add("placed"),document.querySelector(`.gameboard.initial [data-row="${e}"][data-col="${t}"]`).classList.add("placed")})),c+=1,c===l.length)i=!1,(()=>{const o=[];for(let e=0;e<l.length;e+=1){const{type:r,length:a}=l[e];let n=[],c=!1;for(;!c;){const e=Math.floor(10*Math.random()),o=Math.floor(10*Math.random());d=Math.random()<.5,n=[],d?e+a-1<10&&(n=Array.from({length:a},((t,r)=>[e+r,o]))):o+a-1<10&&(n=Array.from({length:a},((t,r)=>[e,o+r]))),n.length>0&&(c=t.placeShip((0,s._V)(a),n))}n.forEach((([e,t])=>{document.querySelector(`.gameboard.computer [data-row="${e}"][data-col="${t}"]`).classList.add("placed")})),o.push({type:r,coordinates:n})}e.getShips().forEach(((t,o)=>{const r=e.getShipCoordinates(t);console.log(`Player's ${l[o].type} coordinates: ${r.join(", ")}`)})),o.sort(((e,t)=>l.findIndex((t=>t.type===e.type))-l.findIndex((e=>e.type===t.type)))).forEach((e=>{const t=e.coordinates.map((([e,t])=>r.r.convertToAlphanumeric([e,t])));console.log(`Computer's ${e.type} coordinates: ${t.join(", ")}`)}))})(),setTimeout((()=>{r.U.toggleModal(document.querySelector(".modal.initial"),"hide")}),500);else{const e=l[c].type;document.querySelector(".ship-type").textContent=e}}}}];return{init:()=>{r.U.toggleModal(document.querySelector(".modal.endgame"),"hide"),a(".gameboard.initial"),a(".gameboard.player"),a(".gameboard.computer"),n(".gameboard.initial",p),document.querySelectorAll(".gameboard.computer .square").forEach((e=>{e.addEventListener("click",u)})),document.querySelector("#rotateBtn").addEventListener("click",h)}}})().init()},776:(e,t,o)=>{o.d(t,{Br:()=>n,_V:()=>a,oP:()=>s});var r=o(555);const a=e=>{let t=0;return{length:e,hit:()=>{t+=1},isSunk:()=>t>=e,get hits(){return t}}},n=()=>{const e=10,t=Array.from({length:e},(()=>Array(e).fill(null))),o=[],a=[],n=()=>{const o=[];for(let r=0;r<e;r+=1)for(let a=0;a<e;a+=1){const e=t[r][a];null===e||!e.ship||o.includes(e.ship)||e.ship.isSunk()||o.push(e.ship)}return o};return{getGrid:()=>t,placeShip:(o,r)=>{const a=r.every((([e,t])=>e>0&&e<9&&t>0&&t<9)),n=r.some((([e,o])=>null!==t[e][o])),s=r.some((([o,r])=>[[o-1,r],[o+1,r],[o,r-1],[o,r+1],[o-1,r-1],[o-1,r+1],[o+1,r-1],[o+1,r+1]].some((([o,r])=>o>=0&&o<e&&r>=0&&r<e&&null!==t[o]?.[r]))));if(a&&!n&&!s){const e={ship:o,coordinates:r};return e.coordinates.forEach((([o,r])=>{t[o][r]=e})),!0}return!1},getShips:n,getShipCoordinates:o=>{const a=[];for(let n=0;n<e;n+=1)for(let s=0;s<e;s+=1){const e=t[n][s];e&&e.ship===o&&a.push(r.r.convertToAlphanumeric([n,s]))}return a},receiveAttack:e=>{const[r,n]=e,s=parseInt(n,10)-1,l=r.charCodeAt(0)-65,c=t[s][l];if(null!==c){const{ship:t}=c;return t.hit(),o.push(e),t}return a.push(e),o.push(e),null},getMissedAttacks:()=>a,getAttackedCoordinates:()=>o,allShipsSunk:()=>{const e=n().every((e=>e.isSunk()));return console.log("All ships sunk:",e),e}}},s=e=>{const t=new Set;return{name:e,attack:e=>{const o=e.getGrid().length,a=r.r.getAllValidCoordinates(o);let n="";do{n=a[Math.floor(Math.random()*a.length)]}while(t.has(n)||e.getAttackedCoordinates().includes(n));return t.add(n),e.receiveAttack(n),n}}}},555:(e,t,o)=>{o.d(t,{U:()=>a,r:()=>r});const r=(()=>{const e=[];return{convertToIndices:e=>{const t=e.charCodeAt(0)-65;return[parseInt(e.slice(1),10)-1,t]},convertToAlphanumeric:([e,t])=>String.fromCharCode(t+65)+(e+1),getAllValidCoordinates:t=>{for(let o=0;o<t;o+=1)for(let a=0;a<t;a+=1){const t=r.convertToAlphanumeric([o,a]);e.push(t)}return e}}})(),a={toggleModal:(e,t)=>{const o=e,r="show"===t?"flex":"none";e.closest(".overlay").style.display=r,o.style.display=r}}}},t={};function o(r){var a=t[r];if(void 0!==a)return a.exports;var n=t[r]={exports:{}};return e[r](n,n.exports,o),n.exports}o.d=(e,t)=>{for(var r in t)o.o(t,r)&&!o.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o(380),o(776)})();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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LEVBQUksQ0FBQ0ssRUFBS0MsSUFBVUwsT0FBT00sVUFBVUMsZUFBZUMsS0FBS0osRUFBS0MsR0NFbEZoQixFQUFvQixLQUVNQSxFQUFvQixJIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vYmF0dGxlc2hpcC8uL3NyYy9yZW5kZXIuanMiLCJ3ZWJwYWNrOi8vYmF0dGxlc2hpcC8uL3NyYy9hcHAuanMiLCJ3ZWJwYWNrOi8vYmF0dGxlc2hpcC8uL3NyYy9mYWN0b3JpZXMuanMiLCJ3ZWJwYWNrOi8vYmF0dGxlc2hpcC8uL3NyYy91dGlscy5qcyIsIndlYnBhY2s6Ly9iYXR0bGVzaGlwL3dlYnBhY2svYm9vdHN0cmFwIiwid2VicGFjazovL2JhdHRsZXNoaXAvd2VicGFjay9ydW50aW1lL2RlZmluZSBwcm9wZXJ0eSBnZXR0ZXJzIiwid2VicGFjazovL2JhdHRsZXNoaXAvd2VicGFjay9ydW50aW1lL2hhc093blByb3BlcnR5IHNob3J0aGFuZCIsIndlYnBhY2s6Ly9iYXR0bGVzaGlwL3dlYnBhY2svc3RhcnR1cCJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBUaGlzIG1vZHVsZSBjYW4gYmUgcmVzcG9uc2libGUgZm9yIHJlbmRlcmluZyBjb250ZW50IG9uIHRoZSBwYWdlLlxuLy8gSXQgY2FuIGluY2x1ZGUgZnVuY3Rpb25zIHRvIHVwZGF0ZSB0aGUgRE9NIGVsZW1lbnRzIHJlcHJlc2VudGluZyB0aGVcbi8vIGdhbWUgYm9hcmRzLCBzaGlwcywgYXR0YWNrcywgbWVzc2FnZXMsIGFuZCBvdGhlciBVSSBjb21wb25lbnRzLiBJdCBzaG91bGRcbi8vIGVuY2Fwc3VsYXRlIHRoZSBET00gbWFuaXB1bGF0aW9uIGNvZGUgYW5kIHByb3ZpZGUgYSBjbGVhbiBpbnRlcmZhY2UgZm9yXG4vLyB1cGRhdGluZyB0aGUgVUkgYmFzZWQgb24gdGhlIGdhbWUgc3RhdGUuIEl0IGNhbiBiZSB0aGUgYnJpZGdlIGJldHdlZW4gdGhlXG4vLyBnYW1lIGxvZ2ljIGFuZCB0aGUgYWN0dWFsIERPTSBtYW5pcHVsYXRpb24uXG5cbmNvbnN0IFJlbmRlcmVyID0gKCgpID0+IHtcbiAgY29uc3QgcmVuZGVyR2FtZWJvYXJkID0gKGNvbnRhaW5lckVsZW1lbnQpID0+IHtcbiAgICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGNvbnRhaW5lckVsZW1lbnQpO1xuXG4gICAgY29udGFpbmVyLnRleHRDb250ZW50ID0gXCJcIjtcblxuICAgIGZvciAobGV0IHJvdyA9IDA7IHJvdyA8IDEwOyByb3cgKz0gMSkge1xuICAgICAgZm9yIChsZXQgY29sID0gMDsgY29sIDwgMTA7IGNvbCArPSAxKSB7XG4gICAgICAgIGNvbnN0IHNxdWFyZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XG4gICAgICAgIHNxdWFyZS5jbGFzc0xpc3QuYWRkKFwic3F1YXJlXCIpO1xuICAgICAgICBzcXVhcmUuZGF0YXNldC5yb3cgPSByb3c7XG4gICAgICAgIHNxdWFyZS5kYXRhc2V0LmNvbCA9IGNvbDtcblxuICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoc3F1YXJlKTtcbiAgICAgIH1cbiAgICB9XG4gIH07XG5cbiAgY29uc3QgYXR0YWNoRXZlbnRMaXN0ZW5lcnMgPSAoY29udGFpbmVyRWxlbWVudCwgZXZlbnRMaXN0ZW5lcnMpID0+IHtcbiAgICBjb25zdCBjb250YWluZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKGNvbnRhaW5lckVsZW1lbnQpO1xuXG4gICAgY29udGFpbmVyLnF1ZXJ5U2VsZWN0b3JBbGwoXCIuc3F1YXJlXCIpLmZvckVhY2goKHNxdWFyZSkgPT4ge1xuICAgICAgZXZlbnRMaXN0ZW5lcnMuZm9yRWFjaCgobGlzdGVuZXIpID0+IHtcbiAgICAgICAgc3F1YXJlLmFkZEV2ZW50TGlzdGVuZXIobGlzdGVuZXIuZXZlbnRUeXBlLCBsaXN0ZW5lci5oYW5kbGVyKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9O1xuXG4gIGNvbnN0IHNldFdpbm5lckhlYWRpbmcgPSAod2lubmVyKSA9PiB7XG4gICAgY29uc3Qgd2lubmVySGVhZGluZyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIjd2lubmVyXCIpO1xuICAgIHdpbm5lckhlYWRpbmcudGV4dENvbnRlbnQgPSBgJHt3aW5uZXJ9IHdvbiFgO1xuICB9O1xuXG4gIHJldHVybiB7XG4gICAgcmVuZGVyR2FtZWJvYXJkLFxuICAgIGF0dGFjaEV2ZW50TGlzdGVuZXJzLFxuICAgIHNldFdpbm5lckhlYWRpbmcsXG4gIH07XG59KSgpO1xuXG5leHBvcnQgZGVmYXVsdCBSZW5kZXJlcjtcbiIsIi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby11bnVzZWQtdmFyc1xuaW1wb3J0IHsgQXBwSGVscGVycywgRmFjdG9yeUhlbHBlcnMgfSBmcm9tIFwiLi91dGlsc1wiO1xuaW1wb3J0IFJlbmRlcmVyIGZyb20gXCIuL3JlbmRlclwiO1xuaW1wb3J0IHsgU2hpcEZhY3RvcnksIEdhbWVib2FyZEZhY3RvcnksIFBsYXllckZhY3RvcnkgfSBmcm9tIFwiLi9mYWN0b3JpZXNcIjtcblxuLy8gMS4gLS0tXG4vLyAyLiAtLS1cbi8vIDMuIC0tLVxuLy8gNC4gLS0tXG4vLyA1LiAtLS1cbi8vIDYuIC0tLVxuLy8gNy4gaGFuZGxlIHdpbm5lclxuLy8gOC4gZGlzcGxheSB3aW5uZXJcblxuY29uc3QgQ29udHJvbGxlciA9ICgoKSA9PiB7XG4gIGNvbnN0IHBsYXllckdhbWVib2FyZCA9IEdhbWVib2FyZEZhY3RvcnkoKTtcbiAgY29uc3QgY29tcHV0ZXJHYW1lYm9hcmQgPSBHYW1lYm9hcmRGYWN0b3J5KCk7XG5cbiAgY29uc3QgY29tcHV0ZXIgPSBQbGF5ZXJGYWN0b3J5KFwiY29tcHV0ZXJcIik7XG5cbiAgY29uc3Qgc2hpcFR5cGVzID0gW1xuICAgIHsgdHlwZTogXCJjYXJyaWVyXCIsIGxlbmd0aDogNSB9LFxuICAgIHsgdHlwZTogXCJiYXR0bGVzaGlwXCIsIGxlbmd0aDogNCB9LFxuICAgIHsgdHlwZTogXCJkZXN0cm95ZXJcIiwgbGVuZ3RoOiAzIH0sXG4gICAgeyB0eXBlOiBcInN1Ym1hcmluZVwiLCBsZW5ndGg6IDMgfSxcbiAgICB7IHR5cGU6IFwicGF0cm9sIGJvYXRcIiwgbGVuZ3RoOiAyIH0sXG4gIF07XG5cbiAgbGV0IGN1cnJlbnRTaGlwSW5kZXggPSAwO1xuICBsZXQgc2hpcFBsYWNlbWVudE1vZGUgPSB0cnVlO1xuICBsZXQgaXNWZXJ0aWNhbCA9IGZhbHNlO1xuXG4gIGNvbnN0IHBsYWNlQ29tcHV0ZXJTaGlwcyA9ICgpID0+IHtcbiAgICBjb25zdCBjb21wdXRlclNoaXBzID0gW107XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNoaXBUeXBlcy5sZW5ndGg7IGkgKz0gMSkge1xuICAgICAgY29uc3QgeyB0eXBlLCBsZW5ndGggfSA9IHNoaXBUeXBlc1tpXTtcbiAgICAgIGxldCBjb29yZGluYXRlcyA9IFtdO1xuICAgICAgbGV0IHBsYWNlZCA9IGZhbHNlO1xuXG4gICAgICB3aGlsZSAoIXBsYWNlZCkge1xuICAgICAgICBjb25zdCBzdGFydFJvdyA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDEwKTtcbiAgICAgICAgY29uc3Qgc3RhcnRDb2wgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAxMCk7XG4gICAgICAgIGlzVmVydGljYWwgPSBNYXRoLnJhbmRvbSgpIDwgMC41O1xuICAgICAgICBjb29yZGluYXRlcyA9IFtdO1xuXG4gICAgICAgIGlmIChpc1ZlcnRpY2FsKSB7XG4gICAgICAgICAgaWYgKHN0YXJ0Um93ICsgbGVuZ3RoIC0gMSA8IDEwKSB7XG4gICAgICAgICAgICBjb29yZGluYXRlcyA9IEFycmF5LmZyb20oeyBsZW5ndGggfSwgKF8sIGopID0+IFtcbiAgICAgICAgICAgICAgc3RhcnRSb3cgKyBqLFxuICAgICAgICAgICAgICBzdGFydENvbCxcbiAgICAgICAgICAgIF0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChzdGFydENvbCArIGxlbmd0aCAtIDEgPCAxMCkge1xuICAgICAgICAgIGNvb3JkaW5hdGVzID0gQXJyYXkuZnJvbSh7IGxlbmd0aCB9LCAoXywgaikgPT4gW1xuICAgICAgICAgICAgc3RhcnRSb3csXG4gICAgICAgICAgICBzdGFydENvbCArIGosXG4gICAgICAgICAgXSk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY29vcmRpbmF0ZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgIHBsYWNlZCA9IGNvbXB1dGVyR2FtZWJvYXJkLnBsYWNlU2hpcChcbiAgICAgICAgICAgIFNoaXBGYWN0b3J5KGxlbmd0aCksXG4gICAgICAgICAgICBjb29yZGluYXRlc1xuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgY29vcmRpbmF0ZXMuZm9yRWFjaCgoW3JvdywgY29sXSkgPT4ge1xuICAgICAgICBjb25zdCBwbGFjZWRTcXVhcmUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFxuICAgICAgICAgIGAuZ2FtZWJvYXJkLmNvbXB1dGVyIFtkYXRhLXJvdz1cIiR7cm93fVwiXVtkYXRhLWNvbD1cIiR7Y29sfVwiXWBcbiAgICAgICAgKTtcbiAgICAgICAgcGxhY2VkU3F1YXJlLmNsYXNzTGlzdC5hZGQoXCJwbGFjZWRcIik7XG4gICAgICB9KTtcblxuICAgICAgY29tcHV0ZXJTaGlwcy5wdXNoKHsgdHlwZSwgY29vcmRpbmF0ZXMgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgcGxheWVyU2hpcHMgPSBwbGF5ZXJHYW1lYm9hcmQuZ2V0U2hpcHMoKTtcbiAgICBwbGF5ZXJTaGlwcy5mb3JFYWNoKChzaGlwLCBpbmRleCkgPT4ge1xuICAgICAgY29uc3QgY29vcmRpbmF0ZXMgPSBwbGF5ZXJHYW1lYm9hcmQuZ2V0U2hpcENvb3JkaW5hdGVzKHNoaXApO1xuICAgICAgY29uc29sZS5sb2coXG4gICAgICAgIGBQbGF5ZXIncyAke3NoaXBUeXBlc1tpbmRleF0udHlwZX0gY29vcmRpbmF0ZXM6ICR7Y29vcmRpbmF0ZXMuam9pbihcbiAgICAgICAgICBcIiwgXCJcbiAgICAgICAgKX1gXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgY29uc3Qgc29ydGVkQ29tcHV0ZXJTaGlwcyA9IGNvbXB1dGVyU2hpcHMuc29ydChcbiAgICAgIChhLCBiKSA9PlxuICAgICAgICBzaGlwVHlwZXMuZmluZEluZGV4KChzKSA9PiBzLnR5cGUgPT09IGEudHlwZSkgLVxuICAgICAgICBzaGlwVHlwZXMuZmluZEluZGV4KChzKSA9PiBzLnR5cGUgPT09IGIudHlwZSlcbiAgICApO1xuXG4gICAgc29ydGVkQ29tcHV0ZXJTaGlwcy5mb3JFYWNoKChzaGlwKSA9PiB7XG4gICAgICBjb25zdCBjb29yZGluYXRlcyA9IHNoaXAuY29vcmRpbmF0ZXMubWFwKChbcm93LCBjb2xdKSA9PlxuICAgICAgICBGYWN0b3J5SGVscGVycy5jb252ZXJ0VG9BbHBoYW51bWVyaWMoW3JvdywgY29sXSlcbiAgICAgICk7XG4gICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgYENvbXB1dGVyJ3MgJHtzaGlwLnR5cGV9IGNvb3JkaW5hdGVzOiAke2Nvb3JkaW5hdGVzLmpvaW4oXCIsIFwiKX1gXG4gICAgICApO1xuICAgIH0pO1xuICB9O1xuXG4gIGNvbnN0IHNoaXBQbGFjZW1lbnRIYW5kbGVyID0gKGUpID0+IHtcbiAgICBpZiAoc2hpcFBsYWNlbWVudE1vZGUpIHtcbiAgICAgIGNvbnN0IHNxdWFyZSA9IGUudGFyZ2V0O1xuICAgICAgY29uc3Qgc3RhcnRSb3cgPSBwYXJzZUludChzcXVhcmUuZGF0YXNldC5yb3csIDEwKTtcbiAgICAgIGNvbnN0IHN0YXJ0Q29sID0gcGFyc2VJbnQoc3F1YXJlLmRhdGFzZXQuY29sLCAxMCk7XG4gICAgICBjb25zdCB7IGxlbmd0aCB9ID0gc2hpcFR5cGVzW2N1cnJlbnRTaGlwSW5kZXhdO1xuXG4gICAgICBjb25zdCBzaGlwQ29vcmRpbmF0ZXMgPSBBcnJheS5mcm9tKHsgbGVuZ3RoIH0sIChfLCBpKSA9PiB7XG4gICAgICAgIGNvbnN0IHJvdyA9IGlzVmVydGljYWwgPyBzdGFydFJvdyArIGkgOiBzdGFydFJvdztcbiAgICAgICAgY29uc3QgY29sID0gaXNWZXJ0aWNhbCA/IHN0YXJ0Q29sIDogc3RhcnRDb2wgKyBpO1xuICAgICAgICByZXR1cm4gW3JvdywgY29sXTtcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCBzaGlwID0gU2hpcEZhY3RvcnkobGVuZ3RoKTtcbiAgICAgIGNvbnN0IHBsYWNlZCA9IHBsYXllckdhbWVib2FyZC5wbGFjZVNoaXAoc2hpcCwgc2hpcENvb3JkaW5hdGVzKTtcblxuICAgICAgaWYgKHBsYWNlZCkge1xuICAgICAgICBzcXVhcmUuY2xhc3NMaXN0LmFkZChcInBsYWNlZFwiKTtcbiAgICAgICAgc2hpcENvb3JkaW5hdGVzLmZvckVhY2goKFtyb3csIGNvbF0pID0+IHtcbiAgICAgICAgICBjb25zdCBwbGFjZWRTcXVhcmUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFxuICAgICAgICAgICAgYFtkYXRhLXJvdz1cIiR7cm93fVwiXVtkYXRhLWNvbD1cIiR7Y29sfVwiXWBcbiAgICAgICAgICApO1xuICAgICAgICAgIHBsYWNlZFNxdWFyZS5jbGFzc0xpc3QuYWRkKFwicGxhY2VkXCIpO1xuICAgICAgICAgIGNvbnN0IGluaXRpYWxTcXVhcmUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFxuICAgICAgICAgICAgYC5nYW1lYm9hcmQuaW5pdGlhbCBbZGF0YS1yb3c9XCIke3Jvd31cIl1bZGF0YS1jb2w9XCIke2NvbH1cIl1gXG4gICAgICAgICAgKTtcbiAgICAgICAgICBpbml0aWFsU3F1YXJlLmNsYXNzTGlzdC5hZGQoXCJwbGFjZWRcIik7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGN1cnJlbnRTaGlwSW5kZXggKz0gMTtcblxuICAgICAgICBpZiAoY3VycmVudFNoaXBJbmRleCA9PT0gc2hpcFR5cGVzLmxlbmd0aCkge1xuICAgICAgICAgIHNoaXBQbGFjZW1lbnRNb2RlID0gZmFsc2U7XG4gICAgICAgICAgcGxhY2VDb21wdXRlclNoaXBzKCk7XG4gICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICBBcHBIZWxwZXJzLnRvZ2dsZU1vZGFsKFxuICAgICAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiLm1vZGFsLmluaXRpYWxcIiksXG4gICAgICAgICAgICAgIFwiaGlkZVwiXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH0sIDUwMCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc3QgbmV4dFNoaXBUeXBlID0gc2hpcFR5cGVzW2N1cnJlbnRTaGlwSW5kZXhdLnR5cGU7XG4gICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIi5zaGlwLXR5cGVcIikudGV4dENvbnRlbnQgPSBuZXh0U2hpcFR5cGU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH07XG5cbiAgY29uc3QgZ2FtZWJvYXJkSG92ZXJIYW5kbGVyID0gKGUpID0+IHtcbiAgICBpZiAoc2hpcFBsYWNlbWVudE1vZGUpIHtcbiAgICAgIGNvbnN0IHNxdWFyZSA9IGUudGFyZ2V0O1xuICAgICAgY29uc3Qgc3RhcnRSb3cgPSBwYXJzZUludChzcXVhcmUuZGF0YXNldC5yb3csIDEwKTtcbiAgICAgIGNvbnN0IHN0YXJ0Q29sID0gcGFyc2VJbnQoc3F1YXJlLmRhdGFzZXQuY29sLCAxMCk7XG4gICAgICBjb25zdCB7IGxlbmd0aCB9ID0gc2hpcFR5cGVzW2N1cnJlbnRTaGlwSW5kZXhdO1xuXG4gICAgICBjb25zdCBob3ZlcmVkU3F1YXJlcyA9IEFycmF5LmZyb20oeyBsZW5ndGggfSwgKF8sIGkpID0+IHtcbiAgICAgICAgY29uc3Qgcm93ID0gaXNWZXJ0aWNhbCA/IHN0YXJ0Um93ICsgaSA6IHN0YXJ0Um93O1xuICAgICAgICBjb25zdCBjb2wgPSBpc1ZlcnRpY2FsID8gc3RhcnRDb2wgOiBzdGFydENvbCArIGk7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgaW5pdGlhbFNxdWFyZTogZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcbiAgICAgICAgICAgIGAuZ2FtZWJvYXJkLmluaXRpYWwgW2RhdGEtcm93PVwiJHtyb3d9XCJdW2RhdGEtY29sPVwiJHtjb2x9XCJdYFxuICAgICAgICAgICksXG4gICAgICAgIH07XG4gICAgICB9KTtcblxuICAgICAgaG92ZXJlZFNxdWFyZXMuZm9yRWFjaCgoeyBpbml0aWFsU3F1YXJlIH0pID0+IHtcbiAgICAgICAgaWYgKGluaXRpYWxTcXVhcmUpIHtcbiAgICAgICAgICBpbml0aWFsU3F1YXJlLmNsYXNzTGlzdC5hZGQoXCJob3ZlcmVkXCIpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH07XG5cbiAgY29uc3QgZ2FtZWJvYXJkTW91c2VMZWF2ZUhhbmRsZXIgPSAoKSA9PiB7XG4gICAgY29uc3QgaG92ZXJlZFNxdWFyZXMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKFwiLmdhbWVib2FyZCAuaG92ZXJlZFwiKTtcbiAgICBob3ZlcmVkU3F1YXJlcy5mb3JFYWNoKChob3ZlcmVkU3F1YXJlKSA9PiB7XG4gICAgICBob3ZlcmVkU3F1YXJlLmNsYXNzTGlzdC5yZW1vdmUoXCJob3ZlcmVkXCIpO1xuICAgIH0pO1xuICB9O1xuXG4gIGNvbnN0IGNvbXB1dGVyQXR0YWNrID0gKCkgPT4ge1xuICAgIGlmICghc2hpcFBsYWNlbWVudE1vZGUpIHtcbiAgICAgIGNvbnN0IGNvb3JkaW5hdGUgPSBjb21wdXRlci5hdHRhY2socGxheWVyR2FtZWJvYXJkKTtcbiAgICAgIGNvbnNvbGUubG9nKGNvb3JkaW5hdGUpO1xuICAgICAgLy8gQVRUQUNLRURTSElQID0gTlVMTFxuICAgICAgLy8gSVNTVUUgSVMgV0hFTiBTSElQUyBHRVQgUExBQ0VEIE9OIFRIRSBCT1RUT00gUk9XXG5cbiAgICAgIC8vIGNvbnN0IGF0dGFja2VkU2hpcCA9IHBsYXllckdhbWVib2FyZC5yZWNlaXZlQXR0YWNrKGNvb3JkaW5hdGUpO1xuICAgICAgLy8gICBjb25zdCByb3cgPSBwYXJzZUludChjb29yZGluYXRlWzFdLCAxMCkgLSAxO1xuICAgICAgLy8gICBjb25zdCBjb2wgPSBjb29yZGluYXRlWzBdLmNoYXJDb2RlQXQoMCkgLSA2NTtcblxuICAgICAgLy8gICBjb25zdCBzcXVhcmUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFxuICAgICAgLy8gICAgIGAuZ2FtZWJvYXJkLnBsYXllciBbZGF0YS1yb3c9XCIke3Jvd31cIl1bZGF0YS1jb2w9XCIke2NvbH1cIl1gXG4gICAgICAvLyAgICk7XG5cbiAgICAgIC8vICAgaWYgKGF0dGFja2VkU2hpcCkge1xuICAgICAgLy8gICAgIHNxdWFyZS5jbGFzc0xpc3QuYWRkKFwiaGl0XCIpO1xuICAgICAgLy8gICAgIGNvbnNvbGUubG9nKGBDb21wdXRlciBoaXQgUGxheWVyIGF0OiAke2Nvb3JkaW5hdGV9YCk7XG5cbiAgICAgIC8vICAgICBpZiAoYXR0YWNrZWRTaGlwLmlzU3VuaygpKSB7XG4gICAgICAvLyAgICAgICBjb25zb2xlLmxvZyhgQ29tcHV0ZXIgc2FuayBQbGF5ZXIncyAke2F0dGFja2VkU2hpcH0hYCk7XG4gICAgICAvLyAgICAgfVxuICAgICAgLy8gICB9IGVsc2Uge1xuICAgICAgLy8gICAgIHNxdWFyZS5jbGFzc0xpc3QuYWRkKFwibWlzc1wiKTtcbiAgICAgIC8vICAgICBjb25zb2xlLmxvZyhgQ29tcHV0ZXIgbWlzc2VkIGF0OiAke2Nvb3JkaW5hdGV9YCk7XG4gICAgICAvLyAgIH1cblxuICAgICAgLy8gICBpZiAocGxheWVyR2FtZWJvYXJkLmFsbFNoaXBzU3VuaygpKSB7XG4gICAgICAvLyAgICAgY29uc29sZS5sb2coXCJDb21wdXRlciB3aW5zIVwiKTtcbiAgICAgIC8vICAgfVxuICAgIH1cbiAgfTtcblxuICBjb25zdCBwbGF5ZXJBdHRhY2sgPSAoZSkgPT4ge1xuICAgIGlmICghc2hpcFBsYWNlbWVudE1vZGUpIHtcbiAgICAgIGNvbnN0IHNxdWFyZSA9IGUudGFyZ2V0O1xuICAgICAgY29uc3Qgcm93ID0gcGFyc2VJbnQoc3F1YXJlLmRhdGFzZXQucm93LCAxMCk7XG4gICAgICBjb25zdCBjb2wgPSBwYXJzZUludChzcXVhcmUuZGF0YXNldC5jb2wsIDEwKTtcbiAgICAgIGNvbnN0IGNvb3JkaW5hdGUgPSBGYWN0b3J5SGVscGVycy5jb252ZXJ0VG9BbHBoYW51bWVyaWMoW3JvdywgY29sXSk7XG5cbiAgICAgIGlmICghY29tcHV0ZXJHYW1lYm9hcmQuZ2V0QXR0YWNrZWRDb29yZGluYXRlcygpLmluY2x1ZGVzKGNvb3JkaW5hdGUpKSB7XG4gICAgICAgIGNvbnN0IGF0dGFja2VkU2hpcCA9IGNvbXB1dGVyR2FtZWJvYXJkLnJlY2VpdmVBdHRhY2soY29vcmRpbmF0ZSk7XG5cbiAgICAgICAgaWYgKGF0dGFja2VkU2hpcCkge1xuICAgICAgICAgIHNxdWFyZS5jbGFzc0xpc3QuYWRkKFwiaGl0XCIpO1xuICAgICAgICAgIGNvbnNvbGUubG9nKGBQbGF5ZXIgaGl0IENvbXB1dGVyIGF0OiAke2Nvb3JkaW5hdGV9YCk7XG5cbiAgICAgICAgICBpZiAoYXR0YWNrZWRTaGlwLmlzU3VuaygpKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgUGxheWVyIHNhbmsgQ29tcHV0ZXIncyAke2F0dGFja2VkU2hpcH0hYCk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHNxdWFyZS5jbGFzc0xpc3QuYWRkKFwibWlzc1wiKTtcbiAgICAgICAgICBjb25zb2xlLmxvZyhgUGxheWVyIG1pc3NlZCBhdDogJHtjb29yZGluYXRlfWApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGNvbXB1dGVyR2FtZWJvYXJkLmFsbFNoaXBzU3VuaygpKSB7XG4gICAgICAgICAgY29uc29sZS5sb2coXCJQbGF5ZXIgd2lucyFcIik7XG4gICAgICAgIH1cblxuICAgICAgICBjb21wdXRlckF0dGFjaygpO1xuICAgICAgfVxuICAgIH1cbiAgfTtcblxuICBjb25zdCByb3RhdGVTaGlwcyA9ICgpID0+IHtcbiAgICBpc1ZlcnRpY2FsID0gIWlzVmVydGljYWw7XG4gIH07XG5cbiAgY29uc3QgZXZlbnRMaXN0ZW5lcnMgPSBbXG4gICAgeyBldmVudFR5cGU6IFwibW91c2VvdmVyXCIsIGhhbmRsZXI6IGdhbWVib2FyZEhvdmVySGFuZGxlciB9LFxuICAgIHsgZXZlbnRUeXBlOiBcIm1vdXNlbGVhdmVcIiwgaGFuZGxlcjogZ2FtZWJvYXJkTW91c2VMZWF2ZUhhbmRsZXIgfSxcbiAgICB7IGV2ZW50VHlwZTogXCJjbGlja1wiLCBoYW5kbGVyOiBzaGlwUGxhY2VtZW50SGFuZGxlciB9LFxuICBdO1xuXG4gIGNvbnN0IGluaXQgPSAoKSA9PiB7XG4gICAgQXBwSGVscGVycy50b2dnbGVNb2RhbChkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwiLm1vZGFsLmVuZGdhbWVcIiksIFwiaGlkZVwiKTtcbiAgICBSZW5kZXJlci5yZW5kZXJHYW1lYm9hcmQoXCIuZ2FtZWJvYXJkLmluaXRpYWxcIik7XG4gICAgUmVuZGVyZXIucmVuZGVyR2FtZWJvYXJkKFwiLmdhbWVib2FyZC5wbGF5ZXJcIik7XG4gICAgUmVuZGVyZXIucmVuZGVyR2FtZWJvYXJkKFwiLmdhbWVib2FyZC5jb21wdXRlclwiKTtcbiAgICBSZW5kZXJlci5hdHRhY2hFdmVudExpc3RlbmVycyhcIi5nYW1lYm9hcmQuaW5pdGlhbFwiLCBldmVudExpc3RlbmVycyk7XG5cbiAgICBjb25zdCBjb21wdXRlclNxdWFyZXMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKFxuICAgICAgXCIuZ2FtZWJvYXJkLmNvbXB1dGVyIC5zcXVhcmVcIlxuICAgICk7XG4gICAgY29tcHV0ZXJTcXVhcmVzLmZvckVhY2goKHNxdWFyZSkgPT4ge1xuICAgICAgc3F1YXJlLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCBwbGF5ZXJBdHRhY2spO1xuICAgIH0pO1xuXG4gICAgY29uc3Qgcm90YXRlQnRuID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcIiNyb3RhdGVCdG5cIik7XG4gICAgcm90YXRlQnRuLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCByb3RhdGVTaGlwcyk7XG4gIH07XG5cbiAgcmV0dXJuIHtcbiAgICBpbml0LFxuICB9O1xufSkoKTtcblxuQ29udHJvbGxlci5pbml0KCk7XG4iLCJpbXBvcnQgeyBGYWN0b3J5SGVscGVycyB9IGZyb20gXCIuL3V0aWxzXCI7XG5cbmV4cG9ydCBjb25zdCBTaGlwRmFjdG9yeSA9IChsZW5ndGgpID0+IHtcbiAgbGV0IGhpdHMgPSAwO1xuXG4gIGNvbnN0IGhpdCA9ICgpID0+IHtcbiAgICBoaXRzICs9IDE7XG4gIH07XG5cbiAgY29uc3QgaXNTdW5rID0gKCkgPT4gaGl0cyA+PSBsZW5ndGg7IC8vIFJldHVybiB0cnVlIGlmIGhpdHMgaXMgZXF1YWwgdG8gb3IgZ3JlYXRlciB0aGFuIGxlbmd0aFxuXG4gIHJldHVybiB7XG4gICAgbGVuZ3RoLFxuICAgIGhpdCxcbiAgICBpc1N1bmssXG4gICAgZ2V0IGhpdHMoKSB7XG4gICAgICAvLyBHZXR0ZXIgZnVuY3Rpb24gZm9yIGhpdHMuIFVzaW5nIGZ1bmN0aW9uIGRlY2xhcmF0aW9uIHRvIGVuc3VyZSBpdCBoYXMgYWNjZXNzIHRvIHRoZVxuICAgICAgLy8gYGhpdHNgIHZhcmlhYmxlIGR5bmFtaWNhbGx5LCBzaW5jZSBmdW5jdGlvbiBkZWNsYXJhdGlvbnMgYXJlIGhvaXN0ZWQgYW5kIGNhbiBiZSB1c2VkXG4gICAgICAvLyBiZWZvcmUgdGhleSBhcmUgZGVmaW5lZC4gVGhpcyBhbGxvd3MgYWNjZXNzaW5nIHRoZSBjdXJyZW50IHZhbHVlIG9mIGBoaXRzYCBldmVuIGJlZm9yZVxuICAgICAgLy8gY2FsbGluZyB0aGUgYGhpdGAgZnVuY3Rpb25cbiAgICAgIHJldHVybiBoaXRzO1xuICAgIH0sXG4gIH07XG59O1xuXG5leHBvcnQgY29uc3QgR2FtZWJvYXJkRmFjdG9yeSA9ICgpID0+IHtcbiAgY29uc3QgZ3JpZFNpemUgPSAxMDtcbiAgY29uc3QgZ3JpZCA9IEFycmF5LmZyb20oeyBsZW5ndGg6IGdyaWRTaXplIH0sICgpID0+XG4gICAgQXJyYXkoZ3JpZFNpemUpLmZpbGwobnVsbClcbiAgKTtcblxuICBjb25zdCBhdHRhY2tlZENvb3JkaW5hdGVzID0gW107XG4gIGNvbnN0IG1pc3NlZEF0dGFja3MgPSBbXTtcblxuICBjb25zdCBnZXRHcmlkID0gKCkgPT4gZ3JpZDtcblxuICBjb25zdCBwbGFjZVNoaXAgPSAoc2hpcCwgY29vcmRpbmF0ZXMpID0+IHtcbiAgICAvLyBDaGVjayBpZiBhbGwgY29vcmRpbmF0ZXMgYXJlIHdpdGhpbiB0aGUgYm91bmRhcmllcyBvZiB0aGUgZ3JpZFxuICAgIGNvbnN0IHdpdGhpbkJvdW5kYXJpZXMgPSBjb29yZGluYXRlcy5ldmVyeShcbiAgICAgIChbcm93LCBjb2xdKSA9PlxuICAgICAgICByb3cgPiAwICYmIHJvdyA8IGdyaWRTaXplIC0gMSAmJiBjb2wgPiAwICYmIGNvbCA8IGdyaWRTaXplIC0gMVxuICAgICk7XG5cbiAgICAvLyBDaGVjayBpZiB0aGVyZSBhcmUgYW55IGNvbmZsaWN0cyB3aXRoIGV4aXN0aW5nIHNoaXAgcGxhY2VtZW50cyBvbiB0aGUgZ3JpZFxuICAgIGNvbnN0IGNvbmZsaWN0cyA9IGNvb3JkaW5hdGVzLnNvbWUoKFtyb3csIGNvbF0pID0+IGdyaWRbcm93XVtjb2xdICE9PSBudWxsKTtcblxuICAgIC8vIENoZWNrIGlmIHRoZXJlIGFyZSBhbnkgYWRqYWNlbnQgY29uZmxpY3RzIHdpdGggZXhpc3Rpbmcgc2hpcCBwbGFjZW1lbnRzIG9uIHRoZSBncmlkXG4gICAgY29uc3QgYWRqYWNlbnRDb25mbGljdHMgPSBjb29yZGluYXRlcy5zb21lKChbcm93LCBjb2xdKSA9PiB7XG4gICAgICAvLyBEZWZpbmUgdGhlIGFkamFjZW50IGNvb3JkaW5hdGVzIGFyb3VuZCB0aGUgY3VycmVudCBjb29yZGluYXRlXG4gICAgICBjb25zdCBhZGphY2VudENvb3JkaW5hdGVzID0gW1xuICAgICAgICBbcm93IC0gMSwgY29sXSwgLy8gVXBcbiAgICAgICAgW3JvdyArIDEsIGNvbF0sIC8vIERvd25cbiAgICAgICAgW3JvdywgY29sIC0gMV0sIC8vIExlZnRcbiAgICAgICAgW3JvdywgY29sICsgMV0sIC8vIFJpZ2h0XG4gICAgICAgIFtyb3cgLSAxLCBjb2wgLSAxXSwgLy8gRGlhZ29uYWwgVXAtTGVmdFxuICAgICAgICBbcm93IC0gMSwgY29sICsgMV0sIC8vIERpYWdvbmFsIFVwLVJpZ2h0XG4gICAgICAgIFtyb3cgKyAxLCBjb2wgLSAxXSwgLy8gRGlhZ29uYWwgRG93bi1MZWZ0XG4gICAgICAgIFtyb3cgKyAxLCBjb2wgKyAxXSwgLy8gRGlhZ29uYWwgRG93bi1SaWdodFxuICAgICAgXTtcblxuICAgICAgLy8gQ2hlY2sgaWYgYW55IGFkamFjZW50IGNvb3JkaW5hdGUgaGFzIGEgc2hpcCBwbGFjZWQgb24gaXRcbiAgICAgIHJldHVybiBhZGphY2VudENvb3JkaW5hdGVzLnNvbWUoXG4gICAgICAgIChbYWRqUm93LCBhZGpDb2xdKSA9PlxuICAgICAgICAgIGFkalJvdyA+PSAwICYmXG4gICAgICAgICAgYWRqUm93IDwgZ3JpZFNpemUgJiZcbiAgICAgICAgICBhZGpDb2wgPj0gMCAmJlxuICAgICAgICAgIGFkakNvbCA8IGdyaWRTaXplICYmXG4gICAgICAgICAgZ3JpZFthZGpSb3ddPy5bYWRqQ29sXSAhPT0gbnVsbFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIC8vIElmIHRoZSBzaGlwIHBsYWNlbWVudCBpcyB3aXRoaW4gZ3JpZCBib3VuZGFyaWVzLCBoYXMgbm8gY29uZmxpY3RzLCBhbmQgbm8gYWRqYWNlbnQgY29uZmxpY3RzLi4uXG4gICAgaWYgKHdpdGhpbkJvdW5kYXJpZXMgJiYgIWNvbmZsaWN0cyAmJiAhYWRqYWNlbnRDb25mbGljdHMpIHtcbiAgICAgIC8vIENyZWF0ZSBhbiBvYmplY3QgY29udGFpbmluZyBzaGlwIGluZm9ybWF0aW9uIGFuZCBjb29yZGluYXRlc1xuICAgICAgY29uc3Qgc2hpcEluZm8gPSB7XG4gICAgICAgIHNoaXAsXG4gICAgICAgIGNvb3JkaW5hdGVzLFxuICAgICAgfTtcblxuICAgICAgLy8gUGxhY2UgdGhlIHNoaXAgb24gdGhlIGdyaWQgYnkgdXBkYXRpbmcgdGhlIGNvcnJlc3BvbmRpbmcgY2VsbHNcbiAgICAgIHNoaXBJbmZvLmNvb3JkaW5hdGVzLmZvckVhY2goKFtyb3csIGNvbF0pID0+IHtcbiAgICAgICAgZ3JpZFtyb3ddW2NvbF0gPSBzaGlwSW5mbztcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4gdHJ1ZTsgLy8gU2hpcCBwbGFjZW1lbnQgc3VjY2Vzc2Z1bFxuICAgIH1cblxuICAgIHJldHVybiBmYWxzZTsgLy8gT3RoZXJ3aXNlLCBzaGlwIHBsYWNlbWVudCBmYWlsZWRcbiAgfTtcblxuICBjb25zdCBnZXRTaGlwcyA9ICgpID0+IHtcbiAgICBjb25zdCBzaGlwcyA9IFtdO1xuXG4gICAgLy8gSXRlcmF0ZSB0aHJvdWdoIGVhY2ggY2VsbCBvZiB0aGUgZ3JpZFxuICAgIGZvciAobGV0IHJvdyA9IDA7IHJvdyA8IGdyaWRTaXplOyByb3cgKz0gMSkge1xuICAgICAgZm9yIChsZXQgY29sID0gMDsgY29sIDwgZ3JpZFNpemU7IGNvbCArPSAxKSB7XG4gICAgICAgIGNvbnN0IGNlbGwgPSBncmlkW3Jvd11bY29sXTtcbiAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIGNlbGwgY29udGFpbnMgYSBzaGlwIGFuZCBpdCdzIG5vdCBhbHJlYWR5IGluY2x1ZGVkIGluIHRoZSBzaGlwcyBhcnJheVxuICAgICAgICBpZiAoXG4gICAgICAgICAgY2VsbCAhPT0gbnVsbCAmJlxuICAgICAgICAgIGNlbGwuc2hpcCAmJlxuICAgICAgICAgICFzaGlwcy5pbmNsdWRlcyhjZWxsLnNoaXApICYmXG4gICAgICAgICAgIWNlbGwuc2hpcC5pc1N1bmsoKVxuICAgICAgICApIHtcbiAgICAgICAgICAvLyBBZGQgdGhlIHNoaXAgdG8gdGhlIHNoaXBzIGFycmF5XG4gICAgICAgICAgc2hpcHMucHVzaChjZWxsLnNoaXApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHNoaXBzO1xuICB9O1xuXG4gIGNvbnN0IGdldFNoaXBDb29yZGluYXRlcyA9IChzaGlwKSA9PiB7XG4gICAgY29uc3QgY29vcmRpbmF0ZXMgPSBbXTtcblxuICAgIC8vIEl0ZXJhdGUgdGhyb3VnaCBlYWNoIGNlbGwgb2YgdGhlIGdyaWRcbiAgICBmb3IgKGxldCByb3cgPSAwOyByb3cgPCBncmlkU2l6ZTsgcm93ICs9IDEpIHtcbiAgICAgIGZvciAobGV0IGNvbCA9IDA7IGNvbCA8IGdyaWRTaXplOyBjb2wgKz0gMSkge1xuICAgICAgICBjb25zdCBjZWxsID0gZ3JpZFtyb3ddW2NvbF07XG4gICAgICAgIC8vIENoZWNrIGlmIHRoZSBjZWxsIGV4aXN0cyBhbmQgY29udGFpbnMgdGhlIHNwZWNpZmllZCBzaGlwXG4gICAgICAgIGlmIChjZWxsICYmIGNlbGwuc2hpcCA9PT0gc2hpcCkge1xuICAgICAgICAgIC8vIENvbnZlcnQgdGhlIHJvdyBhbmQgY29sdW1uIGluZGljZXMgdG8gYWxwaGFudW1lcmljIGNvb3JkaW5hdGVzIGFuZCBhZGQgdGhlbSB0b1xuICAgICAgICAgIC8vIHRoZSBjb29yZGluYXRlcyBhcnJheVxuICAgICAgICAgIGNvb3JkaW5hdGVzLnB1c2goRmFjdG9yeUhlbHBlcnMuY29udmVydFRvQWxwaGFudW1lcmljKFtyb3csIGNvbF0pKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBjb29yZGluYXRlcztcbiAgfTtcblxuICBjb25zdCByZWNlaXZlQXR0YWNrID0gKGNvb3JkaW5hdGUpID0+IHtcbiAgICBjb25zdCBbY29sdW1uTGV0dGVyLCByb3dOdW1iZXJdID0gY29vcmRpbmF0ZTtcbiAgICBjb25zdCByb3cgPSBwYXJzZUludChyb3dOdW1iZXIsIDEwKSAtIDE7XG4gICAgY29uc3QgY29sID0gY29sdW1uTGV0dGVyLmNoYXJDb2RlQXQoMCkgLSA2NTtcbiAgICBjb25zdCBjZWxsID0gZ3JpZFtyb3ddW2NvbF07XG5cbiAgICBpZiAoY2VsbCAhPT0gbnVsbCkge1xuICAgICAgLy8gU2hpcCBhdCBjb29yZGluYXRlLCBpdCdzIGEgaGl0XG4gICAgICBjb25zdCB7IHNoaXAgfSA9IGNlbGw7XG4gICAgICBzaGlwLmhpdCgpOyAvLyBJbmNyZW1lbnQgaGl0IGNvdW50IG9mIHRoZSBzaGlwXG4gICAgICBhdHRhY2tlZENvb3JkaW5hdGVzLnB1c2goY29vcmRpbmF0ZSk7XG4gICAgICByZXR1cm4gc2hpcDsgLy8gUmV0dXJuIHRoZSBzaGlwIG9iamVjdCB3aGVuIGl0IGlzIGhpdFxuICAgIH1cbiAgICAvLyBObyBzaGlwIGF0IGNvb3JkaW5hdGUsIGl0J3MgYSBtaXNzXG4gICAgbWlzc2VkQXR0YWNrcy5wdXNoKGNvb3JkaW5hdGUpO1xuICAgIGF0dGFja2VkQ29vcmRpbmF0ZXMucHVzaChjb29yZGluYXRlKTtcbiAgICByZXR1cm4gbnVsbDsgLy8gUmV0dXJuIG51bGwgd2hlbiBpdCdzIGEgbWlzc1xuICB9O1xuXG4gIGNvbnN0IGdldE1pc3NlZEF0dGFja3MgPSAoKSA9PiBtaXNzZWRBdHRhY2tzO1xuXG4gIGNvbnN0IGdldEF0dGFja2VkQ29vcmRpbmF0ZXMgPSAoKSA9PiBhdHRhY2tlZENvb3JkaW5hdGVzO1xuXG4gIGNvbnN0IGFsbFNoaXBzU3VuayA9ICgpID0+IHtcbiAgICBjb25zdCBzaGlwcyA9IGdldFNoaXBzKCk7IC8vIFJldHJpZXZlIGFsbCB0aGUgc2hpcHMgb24gdGhlIGdhbWVib2FyZFxuXG4gICAgLy8gQ2hlY2sgaWYgYWxsIHNoaXBzIGFyZSBzdW5rLCByZXR1cm4gdHJ1ZSBpZiB5ZXMsIGFuZCByZXR1cm4gZmFsc2UgaWYgbm9cbiAgICBjb25zdCByZXN1bHQgPSBzaGlwcy5ldmVyeSgoc2hpcCkgPT4gc2hpcC5pc1N1bmsoKSk7XG5cbiAgICBjb25zb2xlLmxvZyhcIkFsbCBzaGlwcyBzdW5rOlwiLCByZXN1bHQpOyAvLyBMb2cgdGhlIHJlc3VsdCB0byB0ZXN0XG5cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9O1xuXG4gIHJldHVybiB7XG4gICAgZ2V0R3JpZCxcbiAgICBwbGFjZVNoaXAsXG4gICAgZ2V0U2hpcHMsXG4gICAgZ2V0U2hpcENvb3JkaW5hdGVzLFxuICAgIHJlY2VpdmVBdHRhY2ssXG4gICAgZ2V0TWlzc2VkQXR0YWNrcyxcbiAgICBnZXRBdHRhY2tlZENvb3JkaW5hdGVzLFxuICAgIGFsbFNoaXBzU3VuayxcbiAgfTtcbn07XG5cbmV4cG9ydCBjb25zdCBQbGF5ZXJGYWN0b3J5ID0gKG5hbWUpID0+IHtcbiAgY29uc3QgYXR0YWNrZWRDb29yZGluYXRlcyA9IG5ldyBTZXQoKTsgLy8gU2V0IHRvIGtlZXAgdHJhY2sgb2YgYXR0YWNrZWQgY29vcmRpbmF0ZXNcblxuICBjb25zdCBhdHRhY2sgPSAoZW5lbXlHYW1lYm9hcmQpID0+IHtcbiAgICBjb25zdCBncmlkU2l6ZSA9IGVuZW15R2FtZWJvYXJkLmdldEdyaWQoKS5sZW5ndGg7XG4gICAgY29uc3QgdmFsaWRDb29yZGluYXRlcyA9IEZhY3RvcnlIZWxwZXJzLmdldEFsbFZhbGlkQ29vcmRpbmF0ZXMoZ3JpZFNpemUpO1xuXG4gICAgbGV0IGNvb3JkaW5hdGUgPSBcIlwiO1xuXG4gICAgLy8gUGVyZm9ybSBhIGRvLXdoaWxlIGxvb3AgdW50aWwgYSB1bmlxdWUgY29vcmRpbmF0ZSBpcyBmb3VuZFxuICAgIGRvIHtcbiAgICAgIC8vIEdlbmVyYXRlIGEgcmFuZG9tIGluZGV4IGJhc2VkIG9uIHRoZSBsZW5ndGggb2YgdmFsaWRDb29yZGluYXRlcyBhcnJheVxuICAgICAgY29uc3QgcmFuZG9tSW5kZXggPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiB2YWxpZENvb3JkaW5hdGVzLmxlbmd0aCk7XG5cbiAgICAgIC8vIEdldCB0aGUgY29vcmRpbmF0ZSBhdCB0aGUgcmFuZG9tIGluZGV4XG4gICAgICBjb29yZGluYXRlID0gdmFsaWRDb29yZGluYXRlc1tyYW5kb21JbmRleF07XG4gICAgfSB3aGlsZSAoXG4gICAgICAvLyBDb250aW51ZSBsb29waW5nIHdpdGhvdXQgcGVyZm9ybWluZyBhbnkgYWN0aW9ucyBpZiB0aGUgY29vcmRpbmF0ZSBpcyBhbHJlYWR5XG4gICAgICAvLyBpbiB0aGUgcGxheWVycyBhdHRhY2tlZENvb3JkaW5hdGVzIHNldCBvciBpcyBpbmNsdWRlZCBpbiB0aGUgZW5lbXlHYW1lYm9hcmRzXG4gICAgICAvLyBhdHRhY2tlZENvb3JkaW5hdGVzIGFycmF5XG4gICAgICBhdHRhY2tlZENvb3JkaW5hdGVzLmhhcyhjb29yZGluYXRlKSB8fFxuICAgICAgZW5lbXlHYW1lYm9hcmQuZ2V0QXR0YWNrZWRDb29yZGluYXRlcygpLmluY2x1ZGVzKGNvb3JkaW5hdGUpXG4gICAgKTtcblxuICAgIC8vIEFkZCB0aGUgYXR0YWNrZWQgY29vcmRpbmF0ZSB0byB0aGUgcGxheWVycyBzZXQgb2YgYXR0YWNrZWQgY29vcmRpbmF0ZXNcbiAgICBhdHRhY2tlZENvb3JkaW5hdGVzLmFkZChjb29yZGluYXRlKTtcblxuICAgIC8vIFBlcmZvcm0gdGhlIGF0dGFjayBvbiB0aGUgZW5lbXkgZ2FtZWJvYXJkXG4gICAgZW5lbXlHYW1lYm9hcmQucmVjZWl2ZUF0dGFjayhjb29yZGluYXRlKTtcblxuICAgIHJldHVybiBjb29yZGluYXRlOyAvLyBSZXR1cm4gdGhlIGNvb3JkaW5hdGUgYXMgYW4gYXJyYXlcbiAgfTtcblxuICByZXR1cm4ge1xuICAgIG5hbWUsXG4gICAgYXR0YWNrLFxuICB9O1xufTtcbiIsImV4cG9ydCBjb25zdCBGYWN0b3J5SGVscGVycyA9ICgoKSA9PiB7XG4gIGNvbnN0IHZhbGlkQ29vcmRpbmF0ZXMgPSBbXTtcblxuICBjb25zdCBjb252ZXJ0VG9JbmRpY2VzID0gKGNvb3JkaW5hdGUpID0+IHtcbiAgICBjb25zdCBjb2x1bW4gPSBjb29yZGluYXRlLmNoYXJDb2RlQXQoMCkgLSA2NTsgLy8gQ29udmVydCBjb2x1bW4gbGV0dGVyIHRvIGluZGV4XG4gICAgY29uc3Qgcm93ID0gcGFyc2VJbnQoY29vcmRpbmF0ZS5zbGljZSgxKSwgMTApIC0gMTsgLy8gQ29udmVydCByb3cgbnVtYmVyIHRvIGluZGV4IHdpdGggcmFkaXggMTBcbiAgICByZXR1cm4gW3JvdywgY29sdW1uXTtcbiAgfTtcblxuICBjb25zdCBjb252ZXJ0VG9BbHBoYW51bWVyaWMgPSAoW3JvdywgY29sdW1uXSkgPT4ge1xuICAgIGNvbnN0IGNvb3JkaW5hdGUgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGNvbHVtbiArIDY1KTsgLy8gQ29udmVydCBjb2x1bW4gaW5kZXggdG8gbGV0dGVyXG4gICAgcmV0dXJuIGNvb3JkaW5hdGUgKyAocm93ICsgMSk7IC8vIENvbnZlcnQgcm93IGluZGV4IHRvIG51bWJlclxuICB9O1xuXG4gIGNvbnN0IGdldEFsbFZhbGlkQ29vcmRpbmF0ZXMgPSAoZ3JpZFNpemUpID0+IHtcbiAgICBmb3IgKGxldCByb3cgPSAwOyByb3cgPCBncmlkU2l6ZTsgcm93ICs9IDEpIHtcbiAgICAgIGZvciAobGV0IGNvbCA9IDA7IGNvbCA8IGdyaWRTaXplOyBjb2wgKz0gMSkge1xuICAgICAgICBjb25zdCBhbHBoYW51bWVyaWNDb29yZGluYXRlID0gRmFjdG9yeUhlbHBlcnMuY29udmVydFRvQWxwaGFudW1lcmljKFtcbiAgICAgICAgICByb3csXG4gICAgICAgICAgY29sLFxuICAgICAgICBdKTtcbiAgICAgICAgdmFsaWRDb29yZGluYXRlcy5wdXNoKGFscGhhbnVtZXJpY0Nvb3JkaW5hdGUpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB2YWxpZENvb3JkaW5hdGVzO1xuICB9O1xuXG4gIHJldHVybiB7XG4gICAgY29udmVydFRvSW5kaWNlcyxcbiAgICBjb252ZXJ0VG9BbHBoYW51bWVyaWMsXG4gICAgZ2V0QWxsVmFsaWRDb29yZGluYXRlcyxcbiAgfTtcbn0pKCk7XG5cbmV4cG9ydCBjb25zdCBBcHBIZWxwZXJzID0gKCgpID0+IHtcbiAgY29uc3QgdG9nZ2xlTW9kYWwgPSAobW9kYWwsIGNob2ljZSkgPT4ge1xuICAgIGNvbnN0IHRvZ2dsZWRNb2RhbCA9IG1vZGFsO1xuXG4gICAgY29uc3Qgb3ZlcmxheSA9IG1vZGFsLmNsb3Nlc3QoXCIub3ZlcmxheVwiKTtcbiAgICBjb25zdCBkaXNwbGF5VmFsdWUgPSBjaG9pY2UgPT09IFwic2hvd1wiID8gXCJmbGV4XCIgOiBcIm5vbmVcIjtcblxuICAgIG92ZXJsYXkuc3R5bGUuZGlzcGxheSA9IGRpc3BsYXlWYWx1ZTtcbiAgICB0b2dnbGVkTW9kYWwuc3R5bGUuZGlzcGxheSA9IGRpc3BsYXlWYWx1ZTtcbiAgfTtcblxuICByZXR1cm4ge1xuICAgIHRvZ2dsZU1vZGFsLFxuICB9O1xufSkoKTtcbiIsIi8vIFRoZSBtb2R1bGUgY2FjaGVcbnZhciBfX3dlYnBhY2tfbW9kdWxlX2NhY2hlX18gPSB7fTtcblxuLy8gVGhlIHJlcXVpcmUgZnVuY3Rpb25cbmZ1bmN0aW9uIF9fd2VicGFja19yZXF1aXJlX18obW9kdWxlSWQpIHtcblx0Ly8gQ2hlY2sgaWYgbW9kdWxlIGlzIGluIGNhY2hlXG5cdHZhciBjYWNoZWRNb2R1bGUgPSBfX3dlYnBhY2tfbW9kdWxlX2NhY2hlX19bbW9kdWxlSWRdO1xuXHRpZiAoY2FjaGVkTW9kdWxlICE9PSB1bmRlZmluZWQpIHtcblx0XHRyZXR1cm4gY2FjaGVkTW9kdWxlLmV4cG9ydHM7XG5cdH1cblx0Ly8gQ3JlYXRlIGEgbmV3IG1vZHVsZSAoYW5kIHB1dCBpdCBpbnRvIHRoZSBjYWNoZSlcblx0dmFyIG1vZHVsZSA9IF9fd2VicGFja19tb2R1bGVfY2FjaGVfX1ttb2R1bGVJZF0gPSB7XG5cdFx0Ly8gbm8gbW9kdWxlLmlkIG5lZWRlZFxuXHRcdC8vIG5vIG1vZHVsZS5sb2FkZWQgbmVlZGVkXG5cdFx0ZXhwb3J0czoge31cblx0fTtcblxuXHQvLyBFeGVjdXRlIHRoZSBtb2R1bGUgZnVuY3Rpb25cblx0X193ZWJwYWNrX21vZHVsZXNfX1ttb2R1bGVJZF0obW9kdWxlLCBtb2R1bGUuZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXyk7XG5cblx0Ly8gUmV0dXJuIHRoZSBleHBvcnRzIG9mIHRoZSBtb2R1bGVcblx0cmV0dXJuIG1vZHVsZS5leHBvcnRzO1xufVxuXG4iLCIvLyBkZWZpbmUgZ2V0dGVyIGZ1bmN0aW9ucyBmb3IgaGFybW9ueSBleHBvcnRzXG5fX3dlYnBhY2tfcmVxdWlyZV9fLmQgPSAoZXhwb3J0cywgZGVmaW5pdGlvbikgPT4ge1xuXHRmb3IodmFyIGtleSBpbiBkZWZpbml0aW9uKSB7XG5cdFx0aWYoX193ZWJwYWNrX3JlcXVpcmVfXy5vKGRlZmluaXRpb24sIGtleSkgJiYgIV9fd2VicGFja19yZXF1aXJlX18ubyhleHBvcnRzLCBrZXkpKSB7XG5cdFx0XHRPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywga2V5LCB7IGVudW1lcmFibGU6IHRydWUsIGdldDogZGVmaW5pdGlvbltrZXldIH0pO1xuXHRcdH1cblx0fVxufTsiLCJfX3dlYnBhY2tfcmVxdWlyZV9fLm8gPSAob2JqLCBwcm9wKSA9PiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iaiwgcHJvcCkpIiwiLy8gc3RhcnR1cFxuLy8gTG9hZCBlbnRyeSBtb2R1bGUgYW5kIHJldHVybiBleHBvcnRzXG5fX3dlYnBhY2tfcmVxdWlyZV9fKDM4MCk7XG4vLyBUaGlzIGVudHJ5IG1vZHVsZSBpcyByZWZlcmVuY2VkIGJ5IG90aGVyIG1vZHVsZXMgc28gaXQgY2FuJ3QgYmUgaW5saW5lZFxudmFyIF9fd2VicGFja19leHBvcnRzX18gPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDc3Nik7XG4iXSwibmFtZXMiOlsiY29udGFpbmVyRWxlbWVudCIsImNvbnRhaW5lciIsImRvY3VtZW50IiwicXVlcnlTZWxlY3RvciIsInRleHRDb250ZW50Iiwicm93IiwiY29sIiwic3F1YXJlIiwiY3JlYXRlRWxlbWVudCIsImNsYXNzTGlzdCIsImFkZCIsImRhdGFzZXQiLCJhcHBlbmRDaGlsZCIsImV2ZW50TGlzdGVuZXJzIiwicXVlcnlTZWxlY3RvckFsbCIsImZvckVhY2giLCJsaXN0ZW5lciIsImFkZEV2ZW50TGlzdGVuZXIiLCJldmVudFR5cGUiLCJoYW5kbGVyIiwicGxheWVyR2FtZWJvYXJkIiwiY29tcHV0ZXJHYW1lYm9hcmQiLCJjb21wdXRlciIsInNoaXBUeXBlcyIsInR5cGUiLCJsZW5ndGgiLCJjdXJyZW50U2hpcEluZGV4Iiwic2hpcFBsYWNlbWVudE1vZGUiLCJpc1ZlcnRpY2FsIiwicGxheWVyQXR0YWNrIiwiZSIsInRhcmdldCIsInBhcnNlSW50IiwiY29vcmRpbmF0ZSIsImNvbnZlcnRUb0FscGhhbnVtZXJpYyIsImdldEF0dGFja2VkQ29vcmRpbmF0ZXMiLCJpbmNsdWRlcyIsImF0dGFja2VkU2hpcCIsInJlY2VpdmVBdHRhY2siLCJjb25zb2xlIiwibG9nIiwiaXNTdW5rIiwiYWxsU2hpcHNTdW5rIiwiYXR0YWNrIiwiY29tcHV0ZXJBdHRhY2siLCJyb3RhdGVTaGlwcyIsInN0YXJ0Um93Iiwic3RhcnRDb2wiLCJBcnJheSIsImZyb20iLCJfIiwiaSIsImluaXRpYWxTcXVhcmUiLCJob3ZlcmVkU3F1YXJlIiwicmVtb3ZlIiwic2hpcENvb3JkaW5hdGVzIiwic2hpcCIsInBsYWNlU2hpcCIsImNvbXB1dGVyU2hpcHMiLCJjb29yZGluYXRlcyIsInBsYWNlZCIsIk1hdGgiLCJmbG9vciIsInJhbmRvbSIsImoiLCJwdXNoIiwiZ2V0U2hpcHMiLCJpbmRleCIsImdldFNoaXBDb29yZGluYXRlcyIsImpvaW4iLCJzb3J0IiwiYSIsImIiLCJmaW5kSW5kZXgiLCJzIiwibWFwIiwicGxhY2VDb21wdXRlclNoaXBzIiwic2V0VGltZW91dCIsInRvZ2dsZU1vZGFsIiwibmV4dFNoaXBUeXBlIiwiaW5pdCIsIlNoaXBGYWN0b3J5IiwiaGl0cyIsImhpdCIsIkdhbWVib2FyZEZhY3RvcnkiLCJncmlkU2l6ZSIsImdyaWQiLCJmaWxsIiwiYXR0YWNrZWRDb29yZGluYXRlcyIsIm1pc3NlZEF0dGFja3MiLCJzaGlwcyIsImNlbGwiLCJnZXRHcmlkIiwid2l0aGluQm91bmRhcmllcyIsImV2ZXJ5IiwiY29uZmxpY3RzIiwic29tZSIsImFkamFjZW50Q29uZmxpY3RzIiwiYWRqUm93IiwiYWRqQ29sIiwic2hpcEluZm8iLCJjb2x1bW5MZXR0ZXIiLCJyb3dOdW1iZXIiLCJjaGFyQ29kZUF0IiwiZ2V0TWlzc2VkQXR0YWNrcyIsInJlc3VsdCIsIlBsYXllckZhY3RvcnkiLCJuYW1lIiwiU2V0IiwiZW5lbXlHYW1lYm9hcmQiLCJ2YWxpZENvb3JkaW5hdGVzIiwiZ2V0QWxsVmFsaWRDb29yZGluYXRlcyIsImhhcyIsIkZhY3RvcnlIZWxwZXJzIiwiY29udmVydFRvSW5kaWNlcyIsImNvbHVtbiIsInNsaWNlIiwiU3RyaW5nIiwiZnJvbUNoYXJDb2RlIiwiYWxwaGFudW1lcmljQ29vcmRpbmF0ZSIsIkFwcEhlbHBlcnMiLCJtb2RhbCIsImNob2ljZSIsInRvZ2dsZWRNb2RhbCIsImRpc3BsYXlWYWx1ZSIsImNsb3Nlc3QiLCJzdHlsZSIsImRpc3BsYXkiLCJfX3dlYnBhY2tfbW9kdWxlX2NhY2hlX18iLCJfX3dlYnBhY2tfcmVxdWlyZV9fIiwibW9kdWxlSWQiLCJjYWNoZWRNb2R1bGUiLCJ1bmRlZmluZWQiLCJleHBvcnRzIiwibW9kdWxlIiwiX193ZWJwYWNrX21vZHVsZXNfXyIsImQiLCJkZWZpbml0aW9uIiwia2V5IiwibyIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZW51bWVyYWJsZSIsImdldCIsIm9iaiIsInByb3AiLCJwcm90b3R5cGUiLCJoYXNPd25Qcm9wZXJ0eSIsImNhbGwiXSwic291cmNlUm9vdCI6IiJ9